# 記錄點 #06: 軌跡詳情 - 航點列表

**優先級**: P0
**狀態**: 待開發
**對應測試**: `tests/e2e/user-journey/06-trajectory-detail.spec.ts` (待建立)

---

## 概述

軌跡詳情面板，顯示飛行摘要數據和完整航點列表。支援航點選取和「前往」功能。

---

## 進入方式

- 前置記錄點: #1 → #2 → #3
- 操作步驟:
  1. 進入軌跡頁面
  2. 點擊「軌跡詳情」按鈕 (`button description="軌跡詳情"`)
  3. 等待航點列表渲染（檢查 🏁 出現）

> **重要**: 航點列表需點擊按鈕觸發渲染

---

## DOM 結構與選擇器

| 區域 | 元素 | 選擇器 | 說明 |
|------|------|--------|------|
| 面板 | 容器 | `.info-container` | 主要數據容器 |
| 按鈕 | 開啟 | `button description="軌跡詳情"` | 觸發渲染 |
| 列表 | 航點 | `.info-container` 內文字節點 | TreeWalker 提取 |
| 終點 | 🏁 標記 | 文字節點 `🏁` | 終點航點標識 |

---

## 終點航點 (🏁) 特殊處理

> 終點航點 DOM 結構與普通航點不同

```
普通航點: [航點號] [時間] [累積時間] [距離] [海拔] [速度]
終點航點: [🏁] [航點號] [時間] [累積時間] [距離] [海拔] [速度]
```

**解析方式**:
```typescript
const finishIndex = texts.findIndex(t => t === '🏁');
if (finishIndex !== -1) {
  const waypointNum = texts[finishIndex + 1];  // 86
  const time = texts[finishIndex + 2];          // 11:40:09
  const duration = texts[finishIndex + 3];      // 03:39:09
  const distance = texts[finishIndex + 4];      // 319.42
  const altitude = texts[finishIndex + 5];      // 56
  const speed = texts[finishIndex + 6];         // 0
}
```

---

## 驗證策略

```
Layer 1: 摘要數據健全性檢查 (Strategy A/B)
├── 策略 A: 數值邏輯驗證 (內部一致性)
└── 策略 B: 數值範圍驗證 (領域合理性)

Layer 2: 摘要與航點一致性驗證
└── 摘要面板數據 vs 航點列表計算值

Layer 3: 跨數據源比對 (Strategy C) [可選]
└── 軌跡詳情 vs 排名榜 vs InfoWindow
```

---

## 測試檢查點

### UI 互動驗證

| # | 檢查項目 | 優先級 | 驗證方式 | 狀態 |
|---|---------|--------|---------|------|
| 6.1 | 面板展開 | P0 | `.info-container` 可見 | ⬜ |
| 6.2 | 摘要數據 | P0 | 公環號/時間/距離存在 | ⬜ |
| 6.3 | 航點列表 | P0 | 航點數量 > 0 | ⬜ |
| 6.4 | 終點標記 | P0 | 🏁 存在 | ⬜ |
| 6.5 | 前往功能 | P1 | 選取範圍 → 前往 → 地圖聚焦 | ⬜ |

### 策略 A: 數值邏輯驗證 (P0)

| # | 驗證規則 | 說明 | 狀態 |
|---|---------|------|------|
| 6.6 | 最高分速 ≥ 平均分速 | 最大值必須 ≥ 平均值 | ⬜ |
| 6.7 | 最大高度 ≥ 平均高度 | 最大值必須 ≥ 平均值 | ⬜ |
| 6.8 | 實際距離 ≥ 直線距離 | 實際路徑必定 ≥ 直線 | ⬜ |
| 6.9 | 終點時間 > 起點時間 | 時序邏輯 | ⬜ |

### 策略 B: 數值範圍驗證 (P1)

| # | 驗證項目 | 合理範圍 | 狀態 |
|---|---------|----------|------|
| 6.10 | 分速 | 800 ~ 2000 m/min | ⬜ |
| 6.11 | 高度 | 0 ~ 500 m | ⬜ |
| 6.12 | 距離 | 10 ~ 500 km | ⬜ |

### Layer 2: 摘要與航點一致性驗證 (P0)

| # | 驗證項目 | 計算方式 | 容差 | 狀態 |
|---|---------|----------|------|------|
| 6.13 | 最高分速 | max(航點.speed) | 精確匹配 | ⬜ |
| 6.14 | 最大高度 | max(航點.altitude) | 精確匹配 | ⬜ |
| 6.15 | 實際距離 | 終點航點.distance | 精確匹配 | ⬜ |

---

## 實測驗證記錄

**驗證日期**: 2025-12-03
**測試鴿子**: 27-0162950
**航點數量**: 86 (含終點)
**結果**: ALL PASSED (6/6)

| # | 驗證項目 | 摘要值 | 計算值 | 差異 | 容差 | 結果 |
|---|---------|--------|--------|------|------|------|
| 1 | 最高分速 | 1680 | 1680 | 0 | 精確 | PASS |
| 2 | 最大高度 | 150 | 150 | 0 | 精確 | PASS |
| 3 | 平均分速 | 1419 | 1453 | 34 | ±213 | PASS |
| 4 | 平均高度 | 79 | 80 | 1 | ±8 | PASS |
| 5 | 實際距離 | 319.42 | 319.42 | 0 | 精確 | PASS |
| 6 | 持續時間 | 03:39:09 | 03:39:09 | 0 | 精確 | PASS |

---

## 已知問題

| 問題 | 狀態 | 解決方案 |
|------|------|---------|
| 航點列表需觸發渲染 | 已知 | 點擊「軌跡詳情」按鈕 |

---

## 相關參考

- USER_JOURNEY_RECORD_V2: [記錄點 #06](../USER_JOURNEY_RECORD_V2.md#記錄點-06-軌跡詳情---航點列表)
- 現有 spec: `dev/active/test-flow-refactor/specs/trajectory-validator.spec.md`
- Helper: `tests/helpers/trajectory-validator.ts` - `TrajectoryValidator` 類別

---

## 開發日誌

| 日期 | 內容 |
|------|------|
| 2025-12-03 | DevTools MCP 實測驗證 (6/6 passed) |
| 2025-12-10 | 建立 spec 模板 |
