# Skyracing.com.cn 自动化测试计划总览

## 文档信息
- **项目名称**: PIGEON_RACING_TEST_PROJECT
- **测试目标网站**: https://skyracing.com.cn
- **文档版本**: v1.0.0
- **创建日期**: 2025-11-17
- **测试类型**: 端到端自动化测试 (E2E Automated Testing)
- **测试工具**: Playwright + Playwright MCP
- **参考文档**: [TEST_REPORT.md](../TEST_REPORT.md)

---

## 1. 项目背景与目标

### 1.1 项目背景
Skyracing.com.cn 是一个赛鸽 GPS 追踪系统，提供赛事管理、轨迹查看、2D/3D 可视化等功能。为确保系统稳定性和功能正确性，需要建立完整的自动化测试体系。

### 1.2 测试目标
1. **功能验证**: 确保所有核心功能正常工作
2. **回归测试**: 快速验证新版本未破坏现有功能
3. **数据完整性**: 验证所有数据正确显示和更新
4. **用户体验**: 确保界面元素可交互、响应正常
5. **性能监控**: 记录页面加载时间和渲染性能

### 1.3 成功标准
- ✅ 所有测试用例通过率 ≥ 95%
- ✅ 关键功能（2D/3D轨迹播放）100% 可用
- ✅ 页面加载时间 < 5 秒
- ✅ 无控制台错误（或已知错误已记录）
- ✅ 测试执行时间 < 10 分钟

---

## 2. 测试范围

### 2.1 第一部分：2D/3D 轨迹播放功能测试

#### 2.1.1 2D 静态轨迹查看
- **测试目标**: 验证 2D 模式下完整轨迹显示
- **验证内容**:
  - ✅ 轨迹线正确渲染（红色虚线）
  - ✅ 轨迹点标记可见（≥3个，通常15-20个）
  - ✅ 地图瓦片加载完成（>50个）
  - ✅ 无控制台错误
  - ✅ 起点/终点标记显示（棋盘格旗帜/条纹旗帜）
- **成功标准**: 功能启动 + 数据变化 + 网络请求
- **实际测试结果** (2025-11-17): ✅ 通过 - 完整红色轨迹线显示，15-20个可见标记点

#### 2.1.2 2D 轨迹动画播放
- **测试目标**: 验证 2D 动画播放控制功能
- **验证内容**:
  - ✅ 播放/暂停按钮正常工作
  - ✅ 快进/快退功能
  - ✅ 速度调整（1x - 180x）
  - ✅ 时间戳持续更新
  - ✅ Canvas 渲染变化
  - ✅ Timeline 按钮切换静态/动态模式
- **成功标准**: DOM 变化 + Canvas 更新 + 网络请求
- **实际测试结果** (2025-11-17): ✅ 通过 - Timeline按钮成功切换静态/动态模式，播放控制正常，速度滑块180x工作正常

#### 2.1.3 3D 轨迹播放
- **测试目标**: 验证 3D 模式下轨迹播放
- **验证内容**:
  - ✅ Cesium 3D 引擎加载成功
  - ✅ 3D 轨迹渲染（红色轨迹线+地形）
  - ✅ 视角切换（视角1：倾斜视角、视角2：俯视视角）
  - ✅ 播放控制功能（快退/播放/快进）
  - ✅ 地形数据加载
  - ✅ 小地图和罗盘显示
  - ✅ 速度滑块（180x）
- **成功标准**: Cesium 初始化 + 视觉验证 + 播放功能
- **实际测试结果** (2025-11-17): ✅ 通过 - Cesium 3D渲染正常，视角切换工作，播放控制完整

#### 2.1.4 查看轨迹按钮 2D/3D 模式选择
- **测试目标**: 验证查看轨迹按钮的2D/3D状态切换功能
- **验证内容**:
  - ✅ 2D/3D 切换按钮存在并可点击
  - ✅ 按钮显示文本可在"2D"和"3D"之间切换
  - ✅ 按钮显示"3D"时，点击"查看轨迹"进入3D模式（Cesium 3D引擎，视角切换按钮，播放控制）
  - ✅ 按钮显示"2D"时，点击"查看轨迹"进入2D模式（AMap 2.0平面地图，红色轨迹线，无3D控制）
  - ✅ 模式切换后按钮文本正确更新
- **成功标准**: 按钮状态与实际进入的模式一致
- **实际测试结果** (2025-11-17): ✅ 通过 - 按钮显示的文本（"2D"或"3D"）准确指示点击"查看轨迹"后将进入的模式。测试确认：显示"3D"→进入3D模式，显示"2D"→进入2D模式

### 2.2 第二部分：界面元素测试

#### 2.2.1 首页元素
- 赛事列表显示（≥10个赛事卡片）
- 搜寻功能（关键词过滤）
- 年份筛选器（2020-2025）
- "进入"按钮可点击

#### 2.2.2 赛事详情页元素
- 排名列表表格显示（≥50行）
- 复选框可勾选
- "查看轨迹"按钮状态（禁用→启用）
- 勾选清单计数更新

#### 2.2.3 轨迹详情页面栏位信息
侧边栏数据完整性验证：
- ✅ 公环号（格式: YYYY-NN-NNNNNNN）
- ✅ 起点时间 / 终点时间
- ✅ 持续时间（HH:MM:SS）
- ✅ 平均分速 / 最高分速（m/min）
- ✅ 平均高度 / 最大高度（m）
- ✅ 实际距离 / 直线距离（km）
- ✅ 实际速度 / 直线速度（m/min）

#### 2.2.4 鸽舍列表功能
- 切换到"鸽舍列表"Tab
- 选择鸽舍
- 勾选鸽舍内的鸽子
- 查看轨迹（生成多鸽轨迹）
- 验证多轨迹同时显示

#### 2.2.5 轨迹点详情窗格
点击轨迹点后的信息弹窗验证：
- ✅ 公环号显示
- ✅ 时间（YYYY-MM-DD HH:MM:SS）
- ✅ 速度（m/min）
- ✅ 方向（东/西/南/北）
- ✅ 海拔（m）
- ✅ 名次

---

## 3. 测试策略

### 3.1 三重验证机制

为确保测试可靠性，对关键功能采用三重验证：

| 验证维度 | 验证方法 | 适用场景 |
|---------|---------|---------|
| **DOM 验证** | 检查元素存在性、文本内容、属性变化 | 所有功能 |
| **Canvas 验证** | 截图对比、渲染状态检测 | 2D/3D 轨迹播放 |
| **网络验证** | 监听 API 请求、验证响应数据 | 数据加载功能 |
| **视觉验证** | 截图保存、视觉回归测试 | 界面元素测试 |

### 3.2 等待策略

基于 [TEST_REPORT.md](../TEST_REPORT.md) 的经验，制定等待策略：

```typescript
// 基础等待策略
await page.waitForLoadState('networkidle');  // 网络空闲
await page.waitForTimeout(1000-3000);        // 额外缓冲时间

// 地图加载等待
const tileCount = await page.locator('.amap-container img').count();
expect(tileCount).toBeGreaterThan(50);

// Cesium 3D 加载等待
await page.waitForFunction(() => window.Cesium !== undefined);
await page.waitForFunction(() => window.viewer?.scene.globe.tilesLoaded);

// 元素可见性等待
await page.waitForSelector('[title*="2025-26-"]', { timeout: 5000 });
```

### 3.3 重试机制

对于已知的不稳定操作，内置重试机制：

```typescript
async function switchTo2DMode(page, retries = 2) {
  for (let i = 0; i < retries; i++) {
    try {
      // 执行 3D→2D 切换序列
      // 验证成功后返回
      return true;
    } catch (error) {
      if (i === retries - 1) throw error;
      await page.waitForTimeout(2000);
    }
  }
}
```

---

## 4. 技术栈

### 4.1 核心技术
- **测试框架**: Playwright (TypeScript)
- **交互工具**: Playwright MCP
- **断言库**: @playwright/test expect
- **截图对比**: Playwright Screenshot API
- **报告生成**: Playwright HTML Reporter

### 4.2 目标浏览器
- Chrome/Chromium (主要)
- Firefox (可选)
- WebKit (可选)

### 4.3 依赖库
```json
{
  "@playwright/test": "^1.40.0",
  "typescript": "^5.0.0"
}
```

---

## 5. 测试文件组织

### 5.1 文件结构
```
tests/
├── e2e/                              # 端到端测试
│   ├── 01-race-list.spec.ts         # 赛事列表测试
│   ├── 02-track-2d-static.spec.ts   # 2D 静态轨迹测试
│   ├── 03-track-2d-playback.spec.ts # 2D 动画播放测试
│   ├── 04-track-3d-playback.spec.ts # 3D 轨迹播放测试
│   ├── 05-loft-list.spec.ts         # 鸽舍列表测试
│   ├── 06-trajectory-detail.spec.ts # 轨迹详情测试
│   └── 07-ui-elements.spec.ts       # 界面元素综合测试
├── helpers/                          # 辅助函数
│   ├── navigation.ts                 # 导航辅助
│   ├── mode-switching.ts             # 模式切换
│   ├── trajectory-utils.ts           # 轨迹相关工具
│   ├── loft-list.ts                  # 鸽舍列表工具
│   ├── validators.ts                 # 数据验证
│   └── wait-utils.ts                 # 等待策略
└── screenshots/                      # 截图存储
    └── baseline/                     # 基准截图
```

### 5.2 命名规范
- **测试文件**: `{序号}-{功能描述}.spec.ts`
- **辅助文件**: `{功能分类}.ts`
- **截图文件**: `{功能}-{状态}-{时间戳}.png`

---

## 6. 执行计划

### 6.1 开发阶段

#### 阶段 1: 基础设施搭建（预计 1 天）
- ✅ 安装 Playwright
- ✅ 配置 `playwright.config.ts`
- ✅ 创建文件夹结构
- ✅ 编写基础辅助函数

#### 阶段 2: 核心功能测试（预计 2-3 天）
- ✅ 2D 静态轨迹测试（复用 TEST_REPORT.md 经验）
- ✅ 2D 动画播放测试
- ✅ 3D 轨迹播放测试

#### 阶段 3: 界面元素测试（预计 2 天）
- ✅ 赛事列表和搜寻
- ✅ 轨迹详情面板
- ✅ 鸽舍列表功能
- ✅ 轨迹点窗格

#### 阶段 4: 集成与优化（预计 1 天）
- ✅ 整合所有测试
- ✅ 优化等待策略
- ✅ 添加重试机制
- ✅ 生成测试报告

### 6.2 执行频率
- **每日执行**: 核心功能测试（2D/3D 播放）
- **每周执行**: 完整测试套件
- **发布前**: 完整测试 + 手动验证

---

## 7. 风险与挑战

### 7.1 已知风险（基于 TEST_REPORT.md）

| 风险 | 严重程度 | 缓解措施 |
|------|---------|---------|
| 2D 轨迹初次加载失败 | 🔴 高 | 使用 3D→2D 切换序列 |
| 动态/静态模式混淆 | 🟡 中 | 通过标记数量判断模式 |
| 轨迹点点击无响应 | 🟡 中 | 使用 accessibility 定位 |
| 数据加载时序问题 | 🟡 中 | 增加等待时间 + 重试 |
| Cesium 3D 加载缓慢 | 🟡 中 | 增加超时时间（60s） |

### 7.2 新增风险
- **网络不稳定**: 地图瓦片加载失败
  - 缓解: 重试机制、离线模式测试
- **测试数据变更**: 赛事数据更新导致测试失败
  - 缓解: 使用动态选择器、定期更新基准数据
- **浏览器兼容性**: 不同浏览器渲染差异
  - 缓解: 主要测试 Chrome，其他浏览器可选

---

## 8. 成功指标

### 8.1 质量指标
- ✅ **测试覆盖率**: 核心功能 100%，整体 ≥ 80%
- ✅ **通过率**: ≥ 95%
- ✅ **执行时间**: < 10 分钟
- ✅ **稳定性**: 连续 3 次执行结果一致

### 8.2 性能指标
- ✅ **首页加载**: < 3 秒
- ✅ **轨迹视图加载**: < 5 秒
- ✅ **2D 模式切换**: < 2 秒
- ✅ **3D 模式切换**: < 5 秒

### 8.3 可维护性指标
- ✅ **代码复用率**: ≥ 60%（通过辅助函数）
- ✅ **文档完整性**: 所有函数有注释
- ✅ **失败可追溯**: 截图 + 日志 + 录像

---

## 9. 交付物

### 9.1 代码交付
- ✅ 7 个测试脚本文件
- ✅ 6 个辅助函数模块
- ✅ 1 个配置文件
- ✅ README 说明文档

### 9.2 文档交付
- ✅ 测试计划总览（本文档）
- ✅ 详细测试用例文档
- ✅ 辅助函数设计文档
- ✅ 已知问题解决方案文档
- ✅ API 接口参考文档

### 9.3 报告交付
- ✅ HTML 测试报告
- ✅ 截图证据
- ✅ 性能数据
- ✅ 失败日志

---

## 10. 后续计划

### 10.1 短期计划（1 个月）
- 完善视觉回归测试
- 增加性能监控
- 配置 CI/CD 自动执行

### 10.2 中期计划（3 个月）
- 增加 API 接口测试
- 增加移动端测试
- 建立测试数据管理系统

### 10.3 长期计划（6 个月）
- 建立完整的测试平台
- 集成监控告警系统
- 实现测试自愈能力

---

## 11. 相关文档

- [详细测试用例](./TEST_CASES.md)
- [辅助函数设计](./HELPER_FUNCTIONS_DESIGN.md)
- [已知问题解决方案](./KNOWN_ISSUES_SOLUTIONS.md)
- [API 接口参考](../api-reference/API_ENDPOINTS.md)
- [测试报告 v0.1.0](../TEST_REPORT.md)

---

## 12. 联系信息

- **项目维护**: 测试团队
- **技术支持**: Playwright 官方文档
- **问题反馈**: GitHub Issues
- **最后更新**: 2025-11-17

---

**文档版本**: v1.0.0
**状态**: ✅ 已批准
**下次审查**: 2025-12-17
