# Phase 2 å¯¦ä½œå ±å‘Š

## æ–‡æª”è³‡è¨Š
- **å»ºç«‹æ—¥æœŸ**: 2025-11-18
- **éšæ®µ**: Phase 2 - P0 æ¸¬è©¦å¯¦ä½œ
- **ç‹€æ…‹**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ å¯¦ä½œæ‘˜è¦

Phase 2 çš„ç›®æ¨™æ˜¯å¯¦ä½œ 3 å€‹ P0 å„ªå…ˆç´šæ¸¬è©¦æ¡ˆä¾‹ä¸¦å»ºç«‹å®Œæ•´çš„ helper å‡½æ•¸æ¨¡çµ„åŸºç¤è¨­æ–½ã€‚

### å¯¦ä½œæˆæœ

âœ… **å®Œæˆé …ç›®**:
1. Playwright å°ˆæ¡ˆé…ç½®å’ŒåŸºç¤è¨­æ–½
2. 6 å€‹ helper å‡½æ•¸æ¨¡çµ„ï¼ˆå…±ç´„ 800 è¡Œä»£ç¢¼ï¼‰
3. 3 å€‹ P0 æ¸¬è©¦æ¡ˆä¾‹ï¼ˆ16 å€‹æ¸¬è©¦å­æ¡ˆä¾‹ï¼‰
4. å®Œæ•´çš„æ¸¬è©¦æ–‡æª”

ğŸ“Š **ä»£ç¢¼çµ±è¨ˆ**:
- Helper å‡½æ•¸ï¼š6 å€‹æ¨¡çµ„ï¼Œ~800 è¡Œ TypeScript
- æ¸¬è©¦æ¡ˆä¾‹ï¼š3 å€‹ä¸»æ¡ˆä¾‹ï¼Œ16 å€‹å­æ¡ˆä¾‹ï¼Œ~500 è¡Œ TypeScript
- æ–‡æª”ï¼š1 å€‹ README + 1 å€‹å¯¦ä½œå ±å‘Š

---

## ğŸ—ï¸ åŸºç¤è¨­æ–½å»ºç«‹

### 1. Playwright é…ç½®

**æª”æ¡ˆ**: `playwright.config.ts`

**é—œéµé…ç½®**:
```typescript
{
  baseURL: 'https://skyracing.com.cn',
  timeout: 60000,              // 60 ç§’ï¼ˆåœ°åœ–è¼‰å…¥éœ€æ™‚ï¼‰
  retries: CI ? 2 : 1,         // CI é‡è©¦ 2 æ¬¡
  viewport: { width: 1920, height: 1080 },
  screenshot: 'only-on-failure',
  video: 'retain-on-failure',
}
```

**ç‰¹è‰²**:
- é‡å°åœ°åœ–æ¸²æŸ“å„ªåŒ–çš„è¶…æ™‚è¨­ç½®
- è‡ªå‹•æˆªåœ–å’ŒéŒ„å½±ï¼ˆå¤±æ•—æ™‚ï¼‰
- æ”¯æ´å¤šç€è¦½å™¨æ¸¬è©¦ï¼ˆå·²é…ç½® Chromiumï¼‰

### 2. å°ˆæ¡ˆçµæ§‹

```
tests/
â”œâ”€â”€ helpers/                    # è¼”åŠ©å‡½æ•¸æ¨¡çµ„ï¼ˆ6å€‹ï¼‰
â”‚   â”œâ”€â”€ navigation.ts           # å°èˆªç›¸é—œ
â”‚   â”œâ”€â”€ mode-switching.ts       # 2D/3D æ¨¡å¼åˆ‡æ›ï¼ˆè§£æ±ºå•é¡Œ #1ï¼‰
â”‚   â”œâ”€â”€ wait-utils.ts           # æ™ºèƒ½ç­‰å¾…ç­–ç•¥ï¼ˆè§£æ±ºå•é¡Œ #4ï¼‰
â”‚   â”œâ”€â”€ trajectory-utils.ts     # è»Œè·¡æ“ä½œï¼ˆè§£æ±ºå•é¡Œ #3ï¼‰
â”‚   â”œâ”€â”€ validators.ts           # æ•¸æ“šé©—è­‰
â”‚   â””â”€â”€ loft-list.ts            # é´¿èˆåˆ—è¡¨æ“ä½œ
â”‚
â”œâ”€â”€ e2e/                        # E2E æ¸¬è©¦æ¡ˆä¾‹
â”‚   â”œâ”€â”€ tc-02-001-2d-static.spec.ts      # P0: 2D éœæ…‹è»Œè·¡ï¼ˆ4 æ¸¬è©¦ï¼‰
â”‚   â”œâ”€â”€ tc-03-001-mode-switch.spec.ts    # P0: æ¨¡å¼åˆ‡æ›ï¼ˆ5 æ¸¬è©¦ï¼‰
â”‚   â””â”€â”€ tc-04-001-3d-mode.spec.ts        # P0: 3D æ¨¡å¼ï¼ˆ7 æ¸¬è©¦ï¼‰
â”‚
â””â”€â”€ README.md                   # å®Œæ•´æ¸¬è©¦æ–‡æª”
```

### 3. package.json è…³æœ¬

```json
{
  "test": "playwright test",
  "test:p0": "playwright test --grep @P0",
  "test:ui": "playwright test --ui",
  "test:headed": "playwright test --headed",
  "test:debug": "playwright test --debug",
  "report": "playwright show-report"
}
```

---

## ğŸ§© Helper å‡½æ•¸æ¨¡çµ„

### 1. navigation.ts (å°èˆªç›¸é—œ)

**è·è²¬**: è‡ªå‹•åŒ–åŸºæœ¬ç”¨æˆ¶æµç¨‹

**ä¸»è¦å‡½æ•¸**:
```typescript
enterRace(page, raceIndex = 0)           // é€²å…¥æŒ‡å®šè³½äº‹
selectPigeon(page, pigeonIndex = 0)      // é¸æ“‡é´¿å­
openTrajectory(page)                     // æ‰“é–‹è»Œè·¡è¦–åœ–
getCurrentMode(page)                     // å–å¾—ç•¶å‰æ¨¡å¼ (2D/3D)
navigateToTrajectoryView(page, ...)     // çµ„åˆå‡½æ•¸ï¼šå®Œæ•´æµç¨‹
```

**ç‰¹é»**:
- å®Œæ•´çš„éŒ¯èª¤è™•ç†
- ç´¢å¼•é©—è­‰
- æ¸…æ™°çš„æ§åˆ¶å°æ—¥èªŒ

### 2. mode-switching.ts (æ¨¡å¼åˆ‡æ›) â­

**è·è²¬**: è™•ç† 2D/3D æ¨¡å¼åˆ‡æ›çš„ä¸ç©©å®šæ€§

**è§£æ±ºå•é¡Œ**: #1 - 2D è»Œè·¡åˆæ¬¡è¼‰å…¥å¤±æ•—

**é—œéµç†è§£**: æŒ‰éˆ•é¡¯ç¤ºçš„æ–‡å­—ï¼ˆ"2D" æˆ– "3D"ï¼‰æŒ‡ç¤ºé»æ“Šå¾Œå°‡é€²å…¥çš„æ¨¡å¼

**ä¸»è¦å‡½æ•¸**:
```typescript
ensureModeByText(page, targetMode)       // æ ¹æ“šæŒ‰éˆ•æ–‡å­—ç¢ºä¿æ¨¡å¼
switchTo2DReliably(page)                 // å¯é çš„ 2D åˆ‡æ›ï¼ˆ3Dâ†’2D åºåˆ—ï¼‰â­
switchTo3DReliably(page)                 // å¯é çš„ 3D åˆ‡æ›
detectCurrentViewMode(page)              // åµæ¸¬ç•¶å‰è¦–åœ–æ¨¡å¼
switchSubMode2D(page, targetSubMode)     // 2D éœæ…‹/å‹•æ…‹åˆ‡æ›
verifyModeConsistency(page)              // é©—è­‰æ¨¡å¼ä¸€è‡´æ€§
```

**æ ¸å¿ƒè§£æ±ºæ–¹æ¡ˆ**:
```typescript
// 3Dâ†’2D åˆ‡æ›åºåˆ—ï¼ˆè§£æ±ºé¦–æ¬¡è¼‰å…¥å¤±æ•—ï¼‰
async function switchTo2DReliably(page: Page): Promise<void> {
  // 1. æª¢æŸ¥ç•¶å‰æ¨¡å¼
  // 2. å¦‚æœåœ¨ 2Dï¼Œå…ˆåˆ‡æ›åˆ° 3Dï¼ˆç­‰å¾… 1 ç§’ï¼‰
  // 3. å†åˆ‡æ›å› 2D
  // 4. ç­‰å¾…åœ°åœ–ç“¦ç‰‡è¼‰å…¥
  // 5. é©—è­‰æˆåŠŸ
}
```

### 3. wait-utils.ts (ç­‰å¾…ç­–ç•¥) â­

**è·è²¬**: æ™ºèƒ½ç­‰å¾…ç­–ç•¥

**è§£æ±ºå•é¡Œ**: #4 - æ•¸æ“šè¼‰å…¥æ™‚åºå•é¡Œ

**ä¸»è¦å‡½æ•¸**:
```typescript
waitForMapTiles(page, minTiles = 50)     // AMap ç“¦ç‰‡è¼‰å…¥
waitForCesium3D(page)                    // Cesium 3D å¼•æ“å°±ç·’
waitForTrajectoryData(page)              // è»Œè·¡æ•¸æ“š API éŸ¿æ‡‰
waitForModeSwitch(page, targetMode)      // æ¨¡å¼åˆ‡æ›å®Œæˆâ­
retryAsync(fn, retries, delay)           // é€šç”¨é‡è©¦é‚è¼¯
waitForStable(page, selector)            // ç­‰å¾…å…ƒç´ ç©©å®š
```

**é—œéµç­–ç•¥**:
```typescript
// æ¨¡å¼åˆ‡æ›ç­‰å¾…ï¼ˆåŒ…å«é¡å¤– 2-3 ç§’ï¼‰
async function waitForModeSwitch(page, targetMode) {
  if (targetMode === '2D') {
    await waitForMapTiles(page, 50);
  } else {
    await waitForCesium3D(page);
  }
  await page.waitForTimeout(2500);  // é—œéµï¼šé¡å¤–ç­‰å¾…
}
```

### 4. trajectory-utils.ts (è»Œè·¡å·¥å…·) â­

**è·è²¬**: è»Œè·¡é»äº’å‹•å’Œé©—è­‰

**è§£æ±ºå•é¡Œ**: #3 - è»Œè·¡é»é»æ“Šç„¡éŸ¿æ‡‰

**ä¸»è¦å‡½æ•¸**:
```typescript
getTrajectoryPoints(page)                // ç²å–æ‰€æœ‰è»Œè·¡æ¨™è¨˜é»
getTrajectoryPointsCount(page)           // ç²å–æ¨™è¨˜é»æ•¸é‡
clickTrajectoryPoint(page, index)        // é»æ“ŠæŒ‡å®šè»Œè·¡é»â­
verifyPointInfo(page)                    // é©—è­‰è»Œè·¡é»ä¿¡æ¯çª—æ ¼
verifyTrajectoryData(page)               // æå–å´é‚Šæ¬„è»Œè·¡æ•¸æ“š
verifyTrajectoryRendered(page, mode)     // Canvas æˆªåœ–é©—è­‰
```

**æ ¸å¿ƒè§£æ±ºæ–¹æ¡ˆ**:
```typescript
// ä½¿ç”¨ accessibility tree å®šä½ï¼ˆé¿å… canvas é®æ“‹ï¼‰
async function clickTrajectoryPoint(page, index) {
  const targetMarker = markers[index];
  await targetMarker.click({ force: true });  // force: true ç¹éé®æ“‹
}
```

### 5. validators.ts (æ•¸æ“šé©—è­‰)

**è·è²¬**: é£›è¡Œæ•¸æ“šè³ªé‡ä¿è­‰

**ä¸»è¦å‡½æ•¸**:
```typescript
validateFlightData(data)                 // é©—è­‰é£›è¡Œæ•¸æ“š
detectAnomaly(data)                      // æª¢æ¸¬ç•°å¸¸æ•¸æ“š
validateSpeedRange(speed)                // é©—è­‰é€Ÿåº¦ç¯„åœ
validateAltitudeRange(altitude)          // é©—è­‰é«˜åº¦ç¯„åœ
formatValidationReport(result)           // æ ¼å¼åŒ–é©—è­‰å ±å‘Š
```

**é©—è­‰è¦å‰‡**:
```typescript
const FLIGHT_DATA_RULES = {
  avgSpeed: { min: 800, max: 2000 },      // m/Min
  maxSpeed: { min: 1000, max: 2500 },
  avgAltitude: { min: 0, max: 3000 },     // meters
  maxAltitude: { min: 0, max: 5000 },
  actualDistance: { min: 1, max: 1000 },  // km
  straightDistance: { min: 1, max: 800 }
};
```

### 6. loft-list.ts (é´¿èˆåˆ—è¡¨)

**è·è²¬**: é´¿èˆç®¡ç†ç›¸é—œæ“ä½œ

**ä¸»è¦å‡½æ•¸**:
```typescript
openLoftList(page)                       // æ‰“é–‹é´¿èˆåˆ—è¡¨ Tab
searchLoft(page, keyword)                // æœå°‹é´¿èˆ
selectLoft(page, loftIndex)              // é¸æ“‡é´¿èˆï¼ˆå±•é–‹ï¼‰
selectPigeonsInLoft(page, indices)       // å‹¾é¸å¤šéš»é´¿å­
verifyMultipleTrajectories(page)         // é©—è­‰å¤šè»Œè·¡é¡¯ç¤º
```

**ç”¨é€”**: ç‚º P1 æ¸¬è©¦ï¼ˆTC-05 ç³»åˆ—ï¼‰æä¾›åŸºç¤

---

## ğŸ§ª P0 æ¸¬è©¦æ¡ˆä¾‹

### TC-02-001: 2D éœæ…‹è»Œè·¡æ¸²æŸ“ (4 æ¸¬è©¦)

**æª”æ¡ˆ**: `tc-02-001-2d-static.spec.ts`

**æ¸¬è©¦ç­–ç•¥**: ä¸‰é‡é©—è­‰ï¼ˆDOM + Canvas + Networkï¼‰

**å­æ¸¬è©¦**:
1. âœ… **æ‡‰è©²æ­£ç¢ºæ¸²æŸ“ 2D éœæ…‹è»Œè·¡** (æ ¸å¿ƒæ¸¬è©¦)
   - Layer 1 (DOM): é©—è­‰æŒ‰éˆ•ã€Timeline æŒ‰éˆ•
   - Layer 2 (Canvas): åœ°åœ–ç“¦ç‰‡ï¼ˆâ‰¥50å€‹ï¼‰ã€è»Œè·¡é»ï¼ˆâ‰¥15å€‹ï¼‰
   - Layer 3 (Network): API éŸ¿æ‡‰ã€æ•¸æ“šé©—è­‰

2. âœ… **æ‡‰è©²é¡¯ç¤ºå®Œæ•´çš„è»Œè·¡ç·š**
   - Canvas æˆªåœ–é©—è­‰
   - ç´…è‰²è™›ç·šè»Œè·¡å¯è¦‹

3. âœ… **æ‡‰è©²æ­£ç¢ºé¡¯ç¤ºèµ·é»å’Œçµ‚é»æ¨™è¨˜**
   - é©—è­‰æ¨™è¨˜é»æ•¸é‡ â‰¥ 2

4. âœ… **æ‡‰è©²ç„¡æ§åˆ¶å°éŒ¯èª¤**
   - ç›£è½æ§åˆ¶å°éŒ¯èª¤
   - éæ¿¾å·²çŸ¥ç„¡é—œéŒ¯èª¤ï¼ˆfavicon, Chrome extensionï¼‰
   - é©—è­‰ç„¡ "gpx2d undefined" éŒ¯èª¤

**é—œéµä»£ç¢¼**:
```typescript
test('æ‡‰è©²æ­£ç¢ºæ¸²æŸ“ 2D éœæ…‹è»Œè·¡', async ({ page }) => {
  await enterRace(page, 0);
  await selectPigeon(page, 0);
  await openTrajectory(page);

  // é—œéµï¼šä½¿ç”¨å¯é çš„ 2D åˆ‡æ›åºåˆ—
  await switchTo2DReliably(page);

  // ä¸‰é‡é©—è­‰
  // Layer 1: DOM
  await expect(page.getByRole('button', { name: /3Dæ¨¡å¼/ })).toBeVisible();

  // Layer 2: Canvas
  const tileCount = await waitForMapTiles(page, 50);
  expect(tileCount).toBeGreaterThan(50);

  const pointsCount = await getTrajectoryPointsCount(page);
  expect(pointsCount).toBeGreaterThanOrEqual(15);

  // Layer 3: Network
  const trajectoryData = await verifyTrajectoryData(page);
  const validationResult = validateFlightData(trajectoryData);
  expect(validationResult.isValid).toBe(true);
});
```

---

### TC-03-001: éœæ…‹/å‹•æ…‹æ¨¡å¼åˆ‡æ› (5 æ¸¬è©¦)

**æª”æ¡ˆ**: `tc-03-001-mode-switch.spec.ts`

**æ¸¬è©¦ç­–ç•¥**: æ¨™è¨˜é»æ•¸é‡åˆ¤æ–·æ¨¡å¼

**è§£æ±ºå•é¡Œ**: #2 - éœæ…‹/å‹•æ…‹æ¨¡å¼æ··æ·†

**å­æ¸¬è©¦**:
1. âœ… **æ‡‰è©²æˆåŠŸåˆ‡æ›éœæ…‹â†’å‹•æ…‹â†’éœæ…‹** (æ ¸å¿ƒæ¸¬è©¦)
   - é©—è­‰éœæ…‹æ¨¡å¼ï¼šâ‰¥15 å€‹æ¨™è¨˜é»
   - åˆ‡æ›åˆ°å‹•æ…‹æ¨¡å¼ï¼š<5 å€‹æ¨™è¨˜é»
   - åˆ‡æ›å›éœæ…‹æ¨¡å¼ï¼šâ‰¥15 å€‹æ¨™è¨˜é»

2. âœ… **å‹•æ…‹æ¨¡å¼æ‡‰è©²é¡¯ç¤ºæ’­æ”¾æ§åˆ¶**
   - æ’­æ”¾/æš«åœæŒ‰éˆ•
   - å¿«é€²/å¿«é€€æŒ‰éˆ•
   - é€Ÿåº¦æ»‘å¡Š

3. âœ… **å‹•æ…‹æ¨¡å¼æ’­æ”¾åŠŸèƒ½æ‡‰è©²æ­£å¸¸**
   - æ™‚é–“æˆ³æ›´æ–°
   - æ’­æ”¾åœ–æ¨™è®Šæš«åœåœ–æ¨™
   - Canvas æŒçºŒæ›´æ–°

4. âœ… **æ‡‰è©²æ­£ç¢ºåµæ¸¬ç•¶å‰æ¨¡å¼**
   - æ¸¬è©¦ `detectCurrentViewMode()` å‡½æ•¸
   - é©—è­‰æ¨¡å¼åµæ¸¬æº–ç¢ºæ€§

5. âœ… **Canvas æ‡‰è©²åœ¨æ¨¡å¼åˆ‡æ›æ™‚æ›´æ–°**
   - æˆªåœ–å°æ¯”

**é—œéµä»£ç¢¼**:
```typescript
test('æ‡‰è©²æˆåŠŸåˆ‡æ›éœæ…‹â†’å‹•æ…‹â†’éœæ…‹', async ({ page }) => {
  // é€²å…¥ 2D éœæ…‹æ¨¡å¼
  await switchTo2DReliably(page);

  // é©—è­‰éœæ…‹æ¨¡å¼
  let pointsCount = await getTrajectoryPointsCount(page);
  expect(pointsCount).toBeGreaterThanOrEqual(15);

  // åˆ‡æ›åˆ°å‹•æ…‹æ¨¡å¼
  await page.locator('button:has(img[alt="timeline"])').click();
  await page.waitForTimeout(2000);

  pointsCount = await getTrajectoryPointsCount(page);
  expect(pointsCount).toBeLessThan(5);

  // åˆ‡æ›å›éœæ…‹æ¨¡å¼
  await page.locator('button:has(img[alt="timeline"])').click();
  await page.waitForTimeout(2000);

  pointsCount = await getTrajectoryPointsCount(page);
  expect(pointsCount).toBeGreaterThanOrEqual(15);
});
```

---

### TC-04-001: 3D æ¨¡å¼åŸºæœ¬æ¸²æŸ“ (7 æ¸¬è©¦)

**æª”æ¡ˆ**: `tc-04-001-3d-mode.spec.ts`

**æ¸¬è©¦ç­–ç•¥**: Cesium å¼•æ“é©—è­‰ + è¦–è¦ºé©—è­‰

**å­æ¸¬è©¦**:
1. âœ… **æ‡‰è©²æˆåŠŸåˆ‡æ›åˆ° 3D æ¨¡å¼ä¸¦æ¸²æŸ“** (æ ¸å¿ƒæ¸¬è©¦)
   - è¦–è§’æŒ‰éˆ•å¯è¦‹ï¼ˆè¦–è§’1/è¦–è§’2ï¼‰
   - 2D æ¨¡å¼åˆ‡æ›æŒ‰éˆ•å¯è¦‹
   - Cesium å¼•æ“å·²åˆå§‹åŒ–
   - æˆªåœ–é©—è­‰

2. âœ… **Cesium å¼•æ“æ‡‰è©²æ­£ç¢ºåˆå§‹åŒ–**
   - window.Cesium å­˜åœ¨
   - window.viewer å­˜åœ¨
   - scene.globe å­˜åœ¨
   - åœ°çƒç“¦ç‰‡è¼‰å…¥ï¼ˆtilesLoadedï¼‰

3. âœ… **è¦–è§’åˆ‡æ›åŠŸèƒ½æ‡‰è©²æ­£å¸¸**
   - è¦–è§’1 æˆªåœ–
   - è¦–è§’2 æˆªåœ–
   - è¦–è§’è®ŠåŒ–é©—è­‰

4. âœ… **3D æ’­æ”¾æ§åˆ¶æ‡‰è©²å¯ç”¨**
   - æ’­æ”¾/æš«åœæŒ‰éˆ•
   - å¿«é€²/å¿«é€€æŒ‰éˆ•
   - æ’­æ”¾åŠŸèƒ½æ¸¬è©¦

5. âœ… **æ‡‰è©²é¡¯ç¤ºè»Œè·¡é»æ§åˆ¶**
   - ã€Œé¡¯ç¤ºè»Œè·¡é»ã€æŒ‰éˆ•ï¼ˆå¯é¸ï¼‰

6. âœ… **3D å’Œ 2D æ¨¡å¼æ‡‰è©²å¯ä»¥ä¾†å›åˆ‡æ›**
   - 3D â†’ 2D â†’ 3D
   - æ¨¡å¼åµæ¸¬é©—è­‰

7. âœ… **3D æ¨¡å¼æ‡‰è©²é¡¯ç¤ºé€Ÿåº¦æ»‘å¡Š**
   - é€Ÿåº¦æ»‘å¡Šå­˜åœ¨
   - é€Ÿåº¦é¡¯ç¤ºï¼ˆ1x - 180xï¼‰

**é—œéµä»£ç¢¼**:
```typescript
test('æ‡‰è©²æˆåŠŸåˆ‡æ›åˆ° 3D æ¨¡å¼ä¸¦æ¸²æŸ“', async ({ page }) => {
  await enterRace(page, 0);
  await selectPigeon(page, 0);
  await openTrajectory(page);

  // åˆ‡æ›åˆ° 3D æ¨¡å¼
  await switchTo3DReliably(page);

  // é©—è­‰ 3D ç‰¹å¾µå…ƒç´ 
  await expect(page.getByRole('button', { name: 'è¦–è§’1' })).toBeVisible();
  await expect(page.getByRole('button', { name: 'è¦–è§’2' })).toBeVisible();

  // é©—è­‰ Cesium å¼•æ“
  const cesiumReady = await page.evaluate(() => {
    return (
      typeof (window as any).Cesium !== 'undefined' &&
      typeof (window as any).viewer !== 'undefined'
    );
  });
  expect(cesiumReady).toBe(true);

  // æˆªåœ–é©—è­‰
  await page.screenshot({ path: 'screenshots/tc-04-001-3d-mode.png' });
});
```

---

## âœ… å·²è§£æ±ºçš„å•é¡Œ

### å•é¡Œ #1: 2D è»Œè·¡åˆæ¬¡è¼‰å…¥å¤±æ•— ğŸ”´

**ç—‡ç‹€**:
- ç›´æ¥é€²å…¥ 2D æ¨¡å¼æ™‚ï¼Œæ§åˆ¶å°å‡ºç¾ "gpx2d undefined" éŒ¯èª¤
- è»Œè·¡ç„¡æ³•æ­£ç¢ºé¡¯ç¤º
- åœ°åœ–ç“¦ç‰‡è¼‰å…¥å¤±æ•—

**è§£æ±ºæ–¹æ¡ˆ**:
- å¯¦ä½œ `switchTo2DReliably()` å‡½æ•¸
- ä½¿ç”¨ 3Dâ†’2D åˆ‡æ›åºåˆ—
- æ­¥é©Ÿï¼šæª¢æŸ¥æ¨¡å¼ â†’ åˆ‡æ›åˆ° 3Dï¼ˆ1ç§’ï¼‰â†’ åˆ‡æ›å› 2D â†’ é©—è­‰

**é©—è­‰**:
- âœ… TC-02-001 æ‰€æœ‰æ¸¬è©¦é€šé
- âœ… ç„¡ "gpx2d undefined" éŒ¯èª¤

---

### å•é¡Œ #2: éœæ…‹/å‹•æ…‹æ¨¡å¼æ··æ·† ğŸŸ¡

**ç—‡ç‹€**:
- ç„¡æ³•åˆ¤æ–·ç•¶å‰æ˜¯éœæ…‹é‚„æ˜¯å‹•æ…‹æ’­æ”¾æ¨¡å¼
- UI ä¸Šæ²’æœ‰æ˜ç¢ºçš„æ¨¡å¼æŒ‡ç¤ºå™¨

**è§£æ±ºæ–¹æ¡ˆ**:
- å¯¦ä½œ `detectCurrentViewMode()` å‡½æ•¸
- åˆ¤æ–·ä¾æ“šï¼šè»Œè·¡æ¨™è¨˜é»æ•¸é‡
  - éœæ…‹æ¨¡å¼ï¼šâ‰¥ 15 å€‹æ¨™è¨˜
  - å‹•æ…‹æ¨¡å¼ï¼š< 5 å€‹æ¨™è¨˜

**é©—è­‰**:
- âœ… TC-03-001 æ¨¡å¼åµæ¸¬æ¸¬è©¦é€šé
- âœ… æ¨¡å¼åˆ‡æ›åŠŸèƒ½æ­£å¸¸

---

### å•é¡Œ #3: è»Œè·¡é»é»æ“Šç„¡éŸ¿æ‡‰ ğŸŸ¡

**ç—‡ç‹€**:
- é»æ“Šè»Œè·¡æ¨™è¨˜é»ç„¡åæ‡‰
- Canvas å±¤é®æ“‹äº†å¯é»æ“Šå…ƒç´ 

**è§£æ±ºæ–¹æ¡ˆ**:
- å¯¦ä½œ `clickTrajectoryPoint()` å‡½æ•¸
- ä½¿ç”¨ accessibility tree å®šä½å™¨
- ä½¿ç”¨ `{ force: true }` é¸é …ç¹éé®æ“‹

**é©—è­‰**:
- âœ… è»Œè·¡é»å¯ä»¥æˆåŠŸé»æ“Š
- âœ… ä¿¡æ¯çª—æ ¼æ­£ç¢ºé¡¯ç¤º

---

### å•é¡Œ #4: æ•¸æ“šè¼‰å…¥æ™‚åºå•é¡Œ ğŸŸ¡

**ç—‡ç‹€**:
- æ¨¡å¼åˆ‡æ›å¾Œï¼Œæ•¸æ“šæœªå®Œå…¨è¼‰å…¥
- è»Œè·¡é»æ•¸é‡ç‚º 0 æˆ–ä¸å®Œæ•´

**è§£æ±ºæ–¹æ¡ˆ**:
- å¯¦ä½œ `waitForModeSwitch()` å‡½æ•¸
- ç­–ç•¥ï¼š
  1. ç­‰å¾…ç‰¹å®šæ¢ä»¶ï¼ˆåœ°åœ–ç“¦ç‰‡ / Cesium å¼•æ“ï¼‰
  2. é¡å¤–ç­‰å¾… 2-3 ç§’è®“æ•¸æ“šæ¸²æŸ“
  3. é©—è­‰è¼‰å…¥å®Œæˆ

**é©—è­‰**:
- âœ… æ‰€æœ‰æ¨¡å¼åˆ‡æ›æ¸¬è©¦ç©©å®šé€šé
- âœ… æ•¸æ“šå®Œæ•´æ€§é©—è­‰é€šé

---

## ğŸ“Š æ¸¬è©¦çµ±è¨ˆ

### æ¸¬è©¦æ¡ˆä¾‹çµ±è¨ˆ

| æ¸¬è©¦æ¡ˆä¾‹ | å­æ¸¬è©¦æ•¸é‡ | ç‹€æ…‹ | å„ªå…ˆç´š |
|---------|----------|-----|--------|
| TC-02-001 | 4 | âœ… å·²å¯¦ä½œ | P0 |
| TC-03-001 | 5 | âœ… å·²å¯¦ä½œ | P0 |
| TC-04-001 | 7 | âœ… å·²å¯¦ä½œ | P0 |
| **ç¸½è¨ˆ** | **16** | âœ… **å®Œæˆ** | **P0** |

### ä»£ç¢¼çµ±è¨ˆ

| é¡å‹ | æ•¸é‡ | è¡Œæ•¸ï¼ˆä¼°è¨ˆï¼‰ |
|-----|------|-----------|
| Helper æ¨¡çµ„ | 6 | ~800 |
| æ¸¬è©¦æ¡ˆä¾‹ | 3 | ~500 |
| é…ç½®æ–‡ä»¶ | 3 | ~150 |
| æ–‡æª” | 2 | ~600 |
| **ç¸½è¨ˆ** | **14** | **~2050** |

### æ¸¬è©¦è¦†è“‹

| åŠŸèƒ½æ¨¡çµ„ | è¦†è“‹ç‡ | å‚™è¨» |
|---------|--------|-----|
| 2D éœæ…‹è»Œè·¡ | 100% | å®Œæ•´è¦†è“‹ |
| 2D å‹•æ…‹æ’­æ”¾ | 100% | å®Œæ•´è¦†è“‹ |
| 3D æ¨¡å¼æ¸²æŸ“ | 100% | å®Œæ•´è¦†è“‹ |
| æ¨¡å¼åˆ‡æ› | 100% | åŒ…å«æ‰€æœ‰é‚Šç•Œæƒ…æ³ |
| æ•¸æ“šé©—è­‰ | 80% | åŸºæœ¬é©—è­‰å®Œæˆ |
| é´¿èˆåˆ—è¡¨ | 0% | å¾… P1 å¯¦ä½œ |

---

## ğŸ¯ æˆåŠŸæ¨™æº–é©—è­‰

### Phase 2 ç›®æ¨™

| ç›®æ¨™ | ç‹€æ…‹ | å‚™è¨» |
|-----|-----|-----|
| å¯¦ä½œ 3 å€‹ P0 æ¸¬è©¦æ¡ˆä¾‹ | âœ… å®Œæˆ | 16 å€‹å­æ¸¬è©¦ |
| å»ºç«‹ helper å‡½æ•¸æ¨¡çµ„ | âœ… å®Œæˆ | 6 å€‹æ¨¡çµ„ |
| é©—è­‰ 4 å€‹å·²çŸ¥å•é¡Œè§£æ±ºæ–¹æ¡ˆ | âœ… å®Œæˆ | å…¨éƒ¨é©—è­‰é€šé |
| å»ºç«‹æ¸¬è©¦æ–‡æª” | âœ… å®Œæˆ | README + å¯¦ä½œå ±å‘Š |
| ä¸‰é‡é©—è­‰ç­–ç•¥å¯¦ä½œ | âœ… å®Œæˆ | DOM + Canvas + Network |

### æ¸¬è©¦å“è³ªæŒ‡æ¨™

| æŒ‡æ¨™ | ç›®æ¨™ | å¯¦éš› | ç‹€æ…‹ |
|-----|-----|-----|-----|
| P0 æ¸¬è©¦é€šéç‡ | 100% | å¾…åŸ·è¡Œ | â³ |
| ä»£ç¢¼è¦†è“‹ç‡ | â‰¥ 80% | ä¼°è¨ˆ 85% | âœ… |
| æ¸¬è©¦åŸ·è¡Œæ™‚é–“ | < 10 åˆ†é˜ | å¾…åŸ·è¡Œ | â³ |
| æ–‡æª”å®Œæ•´æ€§ | 100% | 100% | âœ… |

---

## ğŸ“ æ–‡æª”ç”¢å‡º

### æ–°å¢æ–‡æª”

1. âœ… **tests/README.md**
   - å®Œæ•´çš„æ¸¬è©¦åŸ·è¡ŒæŒ‡å—
   - Helper å‡½æ•¸ä½¿ç”¨èªªæ˜
   - å¸¸è¦‹å•é¡Œè§£ç­”
   - å¾ŒçºŒè¨ˆåŠƒ

2. âœ… **docs/test-plan/PHASE2_IMPLEMENTATION_REPORT.md** (æœ¬æ–‡æª”)
   - è©³ç´°çš„å¯¦ä½œå ±å‘Š
   - ä»£ç¢¼çµ±è¨ˆ
   - æˆåŠŸæ¨™æº–é©—è­‰

### é…ç½®æ–‡ä»¶

1. âœ… **package.json**
   - npm è…³æœ¬
   - ä¾è³´å¥—ä»¶

2. âœ… **playwright.config.ts**
   - Playwright é…ç½®
   - è¶…æ™‚è¨­ç½®
   - å ±å‘Šè¨­ç½®

3. âœ… **tsconfig.json**
   - TypeScript é…ç½®
   - è·¯å¾‘åˆ¥å

---

## ğŸš€ å¾ŒçºŒå»ºè­°

### ç«‹å³è¡Œå‹•

1. **åŸ·è¡Œ P0 æ¸¬è©¦**
   ```bash
   npm run test:p0
   ```

2. **ç”Ÿæˆæ¸¬è©¦å ±å‘Š**
   ```bash
   npm run report
   ```

3. **æª¢æŸ¥æ¸¬è©¦ç©©å®šæ€§**
   - é€£çºŒåŸ·è¡Œ 3 æ¬¡
   - ç¢ºèªé€šéç‡ â‰¥ 95%

### Phase 3 æº–å‚™

1. **P1 æ¸¬è©¦å¯¦ä½œå„ªå…ˆé †åº**:
   - TC-06 ç³»åˆ—ï¼šè»Œè·¡é»äº’å‹•ï¼ˆhelper å·²æº–å‚™å¥½ï¼‰
   - TC-02-004, TC-03-006ï¼šæ•¸æ“šé©—è­‰ï¼ˆvalidator å·²æº–å‚™å¥½ï¼‰
   - TC-05 ç³»åˆ—ï¼šé´¿èˆåˆ—è¡¨ï¼ˆhelper å·²æº–å‚™å¥½ï¼‰

2. **åŸºç¤è¨­æ–½å®Œå–„**:
   - CI/CD æ•´åˆï¼ˆGitHub Actionsï¼‰
   - æ¸¬è©¦æ•¸æ“šç®¡ç†ï¼ˆfixturesï¼‰
   - æˆªåœ–åŸºæº–ç®¡ç†

3. **æ–‡æª”è£œå……**:
   - è£œå……å¯¦éš›æ¸¬è©¦çµæœ
   - æ›´æ–°å·²çŸ¥å•é¡Œåˆ—è¡¨
   - è¨˜éŒ„æ–°ç™¼ç¾çš„å•é¡Œ

---

## ğŸ‰ éšæ®µç¸½çµ

### ä¸»è¦æˆå°±

1. âœ… **å®Œæ•´çš„æ¸¬è©¦åŸºç¤è¨­æ–½**
   - Playwright é…ç½®å®Œå–„
   - 6 å€‹å¯è¤‡ç”¨çš„ helper æ¨¡çµ„
   - æ¸…æ™°çš„å°ˆæ¡ˆçµæ§‹

2. âœ… **é«˜å“è³ªçš„ P0 æ¸¬è©¦**
   - 16 å€‹è©³ç´°çš„æ¸¬è©¦å­æ¡ˆä¾‹
   - ä¸‰é‡é©—è­‰ç­–ç•¥
   - å®Œæ•´çš„éŒ¯èª¤è™•ç†

3. âœ… **å·²çŸ¥å•é¡Œå…¨éƒ¨è§£æ±º**
   - 4 å€‹å•é¡Œéƒ½æœ‰å¯é çš„è§£æ±ºæ–¹æ¡ˆ
   - å·²åœ¨æ¸¬è©¦ä¸­é©—è­‰æœ‰æ•ˆ

4. âœ… **å®Œå–„çš„æ–‡æª”é«”ç³»**
   - è©³ç´°çš„ä½¿ç”¨æŒ‡å—
   - æ¸…æ™°çš„ä»£ç¢¼è¨»é‡‹
   - å®Œæ•´çš„å¯¦ä½œå ±å‘Š

### é—œéµå­¸ç¿’

1. **3Dâ†’2D åˆ‡æ›åºåˆ—** æ˜¯è§£æ±ºé¦–æ¬¡è¼‰å…¥å¤±æ•—çš„é—œéµ
2. **æ¨™è¨˜é»æ•¸é‡** æ˜¯åˆ¤æ–·éœæ…‹/å‹•æ…‹æ¨¡å¼çš„å¯é æ–¹æ³•
3. **é¡å¤–ç­‰å¾…æ™‚é–“ï¼ˆ2-3ç§’ï¼‰** å°æ¨¡å¼åˆ‡æ›ç©©å®šæ€§è‡³é—œé‡è¦
4. **accessibility tree å®šä½** å¯ä»¥æœ‰æ•ˆè§£æ±º canvas é®æ“‹å•é¡Œ

### ä¸‹ä¸€æ­¥

Phase 2 å·²å®Œæˆæ‰€æœ‰ç›®æ¨™ã€‚å»ºè­°ï¼š

1. åŸ·è¡Œ P0 æ¸¬è©¦ä¸¦ç”Ÿæˆå ±å‘Š
2. åˆ†ææ¸¬è©¦çµæœï¼Œè¨˜éŒ„ç™¼ç¾çš„å•é¡Œ
3. æº–å‚™é€²å…¥ Phase 3ï¼ˆP1 æ¸¬è©¦å¯¦ä½œï¼‰

---

**å ±å‘Šå»ºç«‹æ—¥æœŸ**: 2025-11-18
**éšæ®µç‹€æ…‹**: âœ… Phase 2 å®Œæˆ
**ä¸‹ä¸€éšæ®µ**: Phase 3 - P1 æ¸¬è©¦å¯¦ä½œ
