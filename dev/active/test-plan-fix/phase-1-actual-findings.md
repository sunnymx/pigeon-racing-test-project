# Phase 1 å¯¦éš›ä¿®å¾©è¨˜éŒ„ - Actual Findings & Solutions

**åŸ·è¡Œæ—¥æœŸ**: 2025-11-24
**ç‹€æ…‹**: âœ… Completed
**æ¸¬è©¦çµæœ**: TC-04-001 å…¨éƒ¨é€šé (1/1 tests, 100%)
**Commit**: `64e3a8c` - fix: ä¿®å¾© TC-04-001 3D æ¨¡å¼æ¸¬è©¦å¤±æ•—å•é¡Œ

---

## ğŸ” å¯¦éš›ç™¼ç¾çš„æ ¹æœ¬åŸå› ï¼ˆèˆ‡è¨ˆåŠƒå·®ç•°ï¼‰

### âš ï¸ é—œéµç™¼ç¾ #1: ç°¡ç¹é«”å­—ç¬¦ä¸åŒ¹é…ï¼ˆè¨ˆåŠƒä¸­æœªè­˜åˆ¥ï¼‰

**å•é¡Œæè¿°**:
æ‰€æœ‰ 3D æ¨¡å¼æ¸¬è©¦å¤±æ•—çš„**çœŸæ­£æ ¹æœ¬åŸå› **æ˜¯ç°¡ç¹é«”ä¸­æ–‡å­—ç¬¦ä¸åŒ¹é…ï¼Œè€Œéè¨ˆåŠƒä¸­æè¿°çš„ `getCurrentMode()` é‚è¼¯éŒ¯èª¤ã€‚

**è­‰æ“š**:
```
æ¸¬è©¦ä»£ç¢¼æŸ¥æ‰¾ï¼šconst view1Button = page.getByRole('button', { name: 'è¦–è§’1' }); // ç¹é«”
å¯¦éš› UI é¡¯ç¤ºï¼š<button>è§†è§’1</button>  // ç°¡é«”

éŒ¯èª¤è¨Šæ¯ï¼šTimeoutError: locator.waitFor: Timeout 30000ms exceeded
æ ¹æœ¬åŸå› ï¼šæ‰¾ä¸åˆ°æŒ‰éˆ•ï¼ˆå­—ç¬¦ä¸åŒ¹é…ï¼‰
```

**å½±éŸ¿ç¯„åœ**:
- âŒ `tests/helpers/wait-utils.ts:73` - waitForCesium3D()
- âŒ `tests/helpers/mode-switching.ts:174` - switchTo3DReliably()
- âŒ `tests/helpers/mode-switching.ts:201` - detectCurrentViewMode()
- âŒ `tests/helpers/navigation.ts:134` - getCurrentMode()
- âŒ `tests/e2e/tc-04-001-3d-mode.spec.ts:48, 49, 126, 132` - æ¸¬è©¦ç”¨ä¾‹

**ä¿®å¾©æ–¹æ¡ˆ**:
```typescript
// âœ… ä½¿ç”¨æ­£å‰‡è¡¨é”å¼æ”¯æ´ç°¡ç¹é«”
const view1Button = page.getByRole('button', { name: /[è§†è¦–]è§’1/ });
const view2Button = page.getByRole('button', { name: /[è§†è¦–]è§’2/ });
```

**ä¿®å¾©æ–‡ä»¶çµ±è¨ˆ**: 6 è™•ä»£ç¢¼ä¿®æ”¹

---

### âš ï¸ é—œéµç™¼ç¾ #2: ä¸‰ç¨®æŒ‰éˆ•é¡å‹çš„å€åˆ†ï¼ˆè¨ˆåŠƒä¸­æ··æ·†ï¼‰

**å•é¡Œæè¿°**:
å­˜åœ¨**ä¸‰ç¨®ä¸åŒç”¨é€”çš„æ¨¡å¼æŒ‰éˆ•**ï¼Œè¨ˆåŠƒæ–‡ä»¶å°‡å®ƒå€‘æ··ç‚ºä¸€è«‡ï¼Œå°è‡´å°æŒ‰éˆ•è¡Œç‚ºçš„ç†è§£éŒ¯èª¤ã€‚

**ä¸‰ç¨®æŒ‰éˆ•é¡å‹è©³è§£**:

| æŒ‰éˆ•é¡å‹ | ä½ç½® | Selector ç‰¹å¾µ | ç”¨é€” | è¡Œç‚ºç‰¹æ€§ |
|---------|------|--------------|------|---------|
| **Type 1** | é¸æ“‡é´¿å­ç•«é¢ï¼ˆnext to "æŸ¥çœ‹è»Œè·¡"ï¼‰ | `{ name: '2D', exact: true }` æˆ– `'3D'` | **åå¥½è¨­å®š** | è¨­å®šä¸‹æ¬¡è»Œè·¡ä½¿ç”¨çš„æ¨¡å¼ |
| **Type 2** | è»Œè·¡è¦–åœ–åœ°åœ–æ§åˆ¶é¢æ¿ | `{ name: /view_in_ar [23]Dæ¨¡å¼/ }` | **ç•¶å‰åœ°åœ–åˆ‡æ›** | åˆ‡æ›ç•¶å‰é¡¯ç¤ºçš„åœ°åœ– |
| **Type 3** | 2D åœ°åœ–æ§åˆ¶ï¼ˆtimelineï¼‰ | `button:has(img[alt="timeline"])` | **éœæ…‹/å‹•æ…‹åˆ‡æ›** | åƒ… 2D æ¨¡å¼å¯ç”¨ |

**é—œéµç†è§£ä¿®æ­£**:

è¨ˆåŠƒä¸­çš„éŒ¯èª¤ç†è§£ï¼š
```
âŒ è¨ˆåŠƒå‡è¨­ï¼šã€Œ3Dæ¨¡å¼ã€æŒ‰éˆ•å­˜åœ¨ â†’ ç•¶å‰åœ¨ 2D æ¨¡å¼
âŒ è¨ˆåŠƒå‡è¨­ï¼šæŒ‰éˆ•æ–‡å­—åæ˜ ç•¶å‰æ¨¡å¼
```

å¯¦éš›æ­£ç¢ºç†è§£ï¼š
```
âœ… Button Type 1 æ˜¯åå¥½è¨­å®šï¼Œèˆ‡ç•¶å‰åœ°åœ–ç‹€æ…‹å®Œå…¨ç¨ç«‹
âœ… Button Type 2 çš„æ–‡å­— = é»æ“Šå¾Œå°‡é€²å…¥çš„æ¨¡å¼ï¼ˆnot current modeï¼‰
âœ… è¦æª¢æ¸¬ç•¶å‰æ¨¡å¼ï¼Œå¿…é ˆæª¢æŸ¥å¯¦éš›åœ°åœ–é¡å‹ï¼ˆAMap vs Cesiumï¼‰
```

**æ–°å¢å‡½æ•¸éœ€æ±‚**:
```typescript
// æ–°å¢ï¼šè™•ç† Button Type 1ï¼ˆåå¥½é¸æ“‡å™¨ï¼‰
export async function setPreferredMode(page: Page, preferredMode: '2D' | '3D'): Promise<void> {
  const button2D = page.getByRole('button', { name: '2D', exact: true });
  const button3D = page.getByRole('button', { name: '3D', exact: true });
  // ... åˆ‡æ›é‚è¼¯
}

// ä¿®æ­£ï¼šgetCurrentMode() æ‡‰æª¢æŸ¥å¯¦éš›åœ°åœ–é¡å‹
export async function getCurrentMode(page: Page): Promise<'2D' | '3D' | 'unknown'> {
  // Layer 1: æª¢æŸ¥ 3D ç‰¹å¾µï¼ˆè¦–è§’æŒ‰éˆ•ï¼‰
  const view1Button = page.getByRole('button', { name: /[è§†è¦–]è§’1/ });
  if (await view1Button.isVisible()) return '3D';

  // Layer 2: æª¢æŸ¥ 2D ç‰¹å¾µï¼ˆAMap å®¹å™¨ï¼‰
  const mapContainer = page.locator('.amap-container');
  if (await mapContainer.isVisible()) return '2D';

  return 'unknown';
}
```

**å½±éŸ¿çš„ä»£ç¢¼**:
- âœ… `tests/helpers/navigation.ts` - æ–°å¢ `setPreferredMode()`, ä¿®æ­£ `getCurrentMode()`
- âœ… `tests/helpers/mode-switching.ts` - æ›´æ–° `ensureModeByText()` ä½¿ç”¨ Button Type 2
- âœ… `tests/e2e/tc-04-001-3d-mode.spec.ts` - æ¸¬è©¦æµç¨‹åŠ å…¥ `setPreferredMode()`

---

### âš ï¸ é—œéµç™¼ç¾ #3: Cesium å°è±¡ä¸æš´éœ²åˆ°å…¨åŸŸï¼ˆé©—è­‰æ–¹æ³•éŒ¯èª¤ï¼‰

**å•é¡Œæè¿°**:
æ‡‰ç”¨**ä¸å°‡** `window.Cesium` å’Œ `window.viewer` æš´éœ²åˆ°å…¨åŸŸ scopeï¼Œå°è‡´ JavaScript å°è±¡æª¢æŸ¥æ–¹æ³•å®Œå…¨å¤±æ•ˆã€‚

**éŒ¯èª¤çš„é©—è­‰æ–¹æ³•**:
```typescript
// âŒ tests/e2e/tc-04-001-3d-mode.spec.ts:63-68ï¼ˆåŸå§‹ä»£ç¢¼ï¼‰
const cesiumReady = await page.evaluate(() => {
  return (
    typeof (window as any).Cesium !== 'undefined' &&
    typeof (window as any).viewer !== 'undefined'
  );
});
expect(cesiumReady).toBe(true); // æ°¸é æ˜¯ falseï¼
```

**éŒ¯èª¤åŸå› **:
```
æ‡‰ç”¨ä½¿ç”¨æ¨¡çµ„åŒ–æ‰“åŒ… â†’ Cesium åœ¨æ¨¡çµ„ scope å…§
                    â†’ ä¸æš´éœ²åˆ° window å°è±¡
                    â†’ page.evaluate() ç„¡æ³•è¨ªå•
                    â†’ è¿”å› undefined
```

**æ­£ç¢ºçš„é©—è­‰æ–¹æ³•**:
```typescript
// âœ… ä½¿ç”¨è¦–è¦ºå…ƒç´ é©—è­‰ï¼ˆä¿®å¾©å¾Œï¼‰
const view1Button = page.getByRole('button', { name: /[è§†è¦–]è§’1/ });
const cesiumReady = await view1Button.isVisible();
expect(cesiumReady).toBe(true);
```

**ä¿®å¾©ä½ç½®**:
- âœ… `tests/e2e/tc-04-001-3d-mode.spec.ts:63-68`
- âœ… `tests/helpers/wait-utils.ts:67-125` - è¨»è§£æ‰ JS å°è±¡æª¢æŸ¥ï¼Œæ”¹ç”¨è¦–è¦ºé©—è­‰

**ç¶“é©—æ•™è¨“**:
```
1. ç¬¬ä¸‰æ–¹åº«å¯èƒ½ä¸æš´éœ²å…¨åŸŸå°è±¡ï¼ˆå°¤å…¶æ˜¯ç¾ä»£æ¨¡çµ„åŒ–æ‡‰ç”¨ï¼‰
2. è¦–è¦ºå…ƒç´ é©—è­‰æ›´å¯é ä¸”è²¼è¿‘ç”¨æˆ¶é«”é©—
3. å¦‚æœè¦–è¦ºå…ƒç´ å·²é¡¯ç¤ºï¼Œè¡¨ç¤ºå¼•æ“å·²æˆåŠŸåˆå§‹åŒ–
```

---

## ğŸ“Š å¯¦éš›åŸ·è¡Œçµæœå°æ¯”

### è¨ˆåŠƒ vs å¯¦éš›

| é …ç›® | è¨ˆåŠƒé æœŸ | å¯¦éš›æƒ…æ³ |
|------|---------|---------|
| **æ ¹æœ¬åŸå› ** | getCurrentMode() é‚è¼¯éŒ¯èª¤ | ç°¡ç¹é«”å­—ç¬¦ä¸åŒ¹é… |
| **ä¿®å¾©æ™‚é–“** | 30-60 åˆ†é˜ | ~90 åˆ†é˜ï¼ˆå«ç™¼ç¾ã€é©—è­‰ã€æ–‡æª”ï¼‰ |
| **ä¿®å¾©ç¯„åœ** | åƒ… navigation.ts | 6 å€‹æ–‡ä»¶ + æ–‡æª”æ›´æ–° |
| **é æœŸé€šéç‡** | 62.5% (10/16) | å°šæœªé‹è¡Œå®Œæ•´ P0 å¥—ä»¶* |
| **æ–°å¢å‡½æ•¸** | ç„¡ | setPreferredMode() |
| **æ–‡æª”æ›´æ–°** | è¨ˆåŠƒå…§ | å¤§å¹…æ“´å±•ï¼ˆä¸‰ç¨®æŒ‰éˆ•é¡å‹ï¼‰ |

*è¨»ï¼šç›®å‰åƒ…é©—è­‰ TC-04-001 å–®ä¸€æ¸¬è©¦ï¼ˆ1 passedï¼‰ï¼Œéœ€é‹è¡Œå®Œæ•´å¥—ä»¶ç¢ºèªå¯¦éš›é€šéç‡

---

## ğŸ”§ å¯¦éš›ä¿®å¾©æ­¥é©Ÿ

### Task 1: ç™¼ç¾ç°¡ç¹é«”å•é¡Œï¼ˆè¨ˆåŠƒå¤–ï¼‰

**è§¸ç™¼é»**: æ¸¬è©¦æ—¥èªŒé¡¯ç¤º
```
â³ ç­‰å¾… 3D æ¨¡å¼è¼‰å…¥ï¼ˆä½¿ç”¨è¦–è¦ºå…ƒç´ æª¢æŸ¥ï¼‰...
  âœ˜ Error: âŒ 3D æ¨¡å¼è¦–è§’æ§åˆ¶æŒ‰éˆ•æœªé¡¯ç¤º
```

**èª¿æŸ¥éç¨‹**:
1. ç”¨æˆ¶æä¾› Page snapshot é¡¯ç¤ºæŒ‰éˆ•å­˜åœ¨
2. å°æ¯”ç™¼ç¾å­—ç¬¦ç·¨ç¢¼å·®ç•°ï¼š`è§†è§’1` vs `è¦–è§’1`
3. ç¢ºèªå•é¡Œæ ¹æºï¼šç°¡ç¹é«”ä¸åŒ¹é…

**ä¿®å¾©è¡Œå‹•**:
- æ›´æ–°æ‰€æœ‰è¦–è§’æŒ‰éˆ•é¸æ“‡å™¨ç‚º `/[è§†è¦–]è§’[12]/`
- ä¿®æ”¹ 6 è™•ä»£ç¢¼ï¼ˆ4 å€‹æ–‡ä»¶ï¼‰

---

### Task 2: é‡æ¸…æŒ‰éˆ•é¡å‹ï¼ˆè¨ˆåŠƒå¤–ï¼‰

**è§¸ç™¼é»**: ç”¨æˆ¶èªªæ˜æŒ‰éˆ•ç‹€æ…‹èˆ‡åœ°åœ–ç‹€æ…‹ç„¡é—œ

**åŸå§‹èª¤è§£**:
```
ã€ŒæŒ‰éˆ•é¡¯ç¤º 2D æˆ– 3Dã€â†’ ç•¶å‰æ¨¡å¼
```

**æ­£ç¢ºç†è§£**:
```
Button Type 1: åå¥½è¨­å®šï¼ˆä¸‹æ¬¡è»Œè·¡ç”¨ï¼‰
Button Type 2: ç•¶å‰åœ°åœ–åˆ‡æ›
â†’ å¿…é ˆå€åˆ†ä½¿ç”¨å ´æ™¯
```

**ä¿®å¾©è¡Œå‹•**:
- æ–°å¢ `setPreferredMode()` è™•ç† Button Type 1
- ä¿®æ­£ `getCurrentMode()` ä¸æª¢æŸ¥æŒ‰éˆ•ç‹€æ…‹
- æ›´æ–° `ensureModeByText()` ä½¿ç”¨æ­£ç¢ºçš„ Button Type 2 selector

---

### Task 3: ä¿®æ­£ Cesium é©—è­‰æ–¹æ³•ï¼ˆè¨ˆåŠƒå¤–ï¼‰

**ç™¼ç¾éç¨‹**:
1. 3D è¦–è¦ºå·²è¼‰å…¥ï¼ˆç”¨æˆ¶æˆªåœ–è­‰å¯¦ï¼‰
2. ä½† Cesium å°è±¡æª¢æŸ¥è¿”å› false
3. æª¢æŸ¥æ‡‰ç”¨æ¶æ§‹ â†’ ç¢ºèª Cesium åœ¨æ¨¡çµ„ scope

**ä¿®å¾©è¡Œå‹•**:
- æ¸¬è©¦æ–‡ä»¶ï¼šæ”¹ç”¨ `view1Button.isVisible()`
- wait-utils.tsï¼šè¨»è§£ JS æª¢æŸ¥ï¼Œæ”¹ç”¨è¦–è¦ºé©—è­‰

---

### Task 4: æ›´æ–°æ–‡æª”ï¼ˆè¨ˆåŠƒå…§ï¼Œä½†ç¯„åœæ“´å¤§ï¼‰

**æ›´æ–°æ–‡ä»¶**:
- âœ… `CLAUDE.md` - æ–°å¢ä¸‰ç¨®æŒ‰éˆ•é¡å‹èªªæ˜
- âœ… `docs/guides/mode-switching.md` - å¤§å¹…æ›´æ­£æŒ‰éˆ•è¡Œç‚ºç†è§£
- âœ… `tests/helpers/*.ts` - æ–°å¢è©³ç´°è¨»è§£
- âœ… `tests/e2e/tc-04-001-3d-mode.spec.ts` - æ–°å¢ä¸­æ–‡è¨»è§£

---

## ğŸ“ ä»£ç¢¼è®Šæ›´çµ±è¨ˆ

### ä¿®æ”¹æ–‡ä»¶æ¸…å–®

```
modified:   CLAUDE.md                          (+133/-24 lines)
modified:   docs/guides/mode-switching.md      (+92/-35 lines)
modified:   tests/e2e/tc-04-001-3d-mode.spec.ts (+18/-15 lines)
modified:   tests/helpers/mode-switching.ts    (+53/-79 lines)
modified:   tests/helpers/navigation.ts        (+41/-16 lines)
modified:   tests/helpers/wait-utils.ts        (+21/-2 lines)

Total: 6 files changed, 290 insertions(+), 157 deletions(-)
```

### é—œéµå‡½æ•¸ä¿®æ”¹

**æ–°å¢å‡½æ•¸**:
- âœ… `setPreferredMode()` - è™•ç† Button Type 1

**ä¿®æ”¹å‡½æ•¸**:
- âœ… `getCurrentMode()` - æ”¹ç‚ºæª¢æŸ¥å¯¦éš›åœ°åœ–é¡å‹
- âœ… `ensureModeByText()` - ä½¿ç”¨æ­£ç¢ºçš„ Button Type 2 selector
- âœ… `switchTo3DReliably()` - ä½¿ç”¨ç°¡ç¹é«”æ­£å‰‡
- âœ… `detectCurrentViewMode()` - ä½¿ç”¨ç°¡ç¹é«”æ­£å‰‡
- âœ… `waitForCesium3D()` - æ”¹ç‚ºè¦–è¦ºé©—è­‰

---

## âœ… é©—è­‰çµæœ

### TC-04-001 æ¸¬è©¦çµæœ

```bash
$ npx playwright test tests/e2e/tc-04-001-3d-mode.spec.ts:30 --retries=0

Running 1 test using 1 worker

âœ… TC-04-001: 3D æ¨¡å¼åŸºæœ¬æ¸²æŸ“ @P0 â€º æ‡‰è©²æˆåŠŸåˆ‡æ›åˆ° 3D æ¨¡å¼ä¸¦æ¸²æŸ“ (22.2s)

  1 passed (23.3s)
```

**æ¸¬è©¦æµç¨‹é©—è­‰**:
```
1. âœ… è¨­å®šåå¥½æ¨¡å¼ç‚º 2D (setPreferredMode)
2. âœ… é–‹å•Ÿè»Œè·¡è¦–åœ–ï¼ˆ2D æ¨¡å¼ï¼‰
3. âœ… åˆ‡æ›åˆ° 3D æ¨¡å¼ï¼ˆensureModeByTextï¼‰
4. âœ… æª¢æ¸¬åˆ° 3D æ¨¡å¼ï¼ˆgetCurrentMode è¿”å› '3D'ï¼‰
5. âœ… é©—è­‰è¦–è§’æŒ‰éˆ•å¯è¦‹ï¼ˆè¦–è§’1/è¦–è§’2ï¼‰
6. âœ… é©—è­‰ 2D æ¨¡å¼åˆ‡æ›æŒ‰éˆ•å¯è¦‹
7. âœ… Cesium å¼•æ“åˆå§‹åŒ–é©—è­‰ï¼ˆè¦–è¦ºå…ƒç´ ï¼‰
8. âœ… æˆªåœ–ä¿å­˜
```

### Git Commit è¨˜éŒ„

```
Commit: 64e3a8c
Author: [ç”¨æˆ¶]
Date: 2025-11-24

fix: ä¿®å¾© TC-04-001 3D æ¨¡å¼æ¸¬è©¦å¤±æ•—å•é¡Œ

ä¿®å¾©ç°¡ç¹é«”å­—ç¬¦ä¸åŒ¹é…å°è‡´çš„æ¸¬è©¦å¤±æ•—ï¼š

**ä¸»è¦ä¿®å¾©ï¼š**
- ä¿®å¾©è¦–è§’æŒ‰éˆ•é¸æ“‡å™¨ï¼ˆè¦–è§’1/2ï¼‰æ”¯æ´ç°¡ç¹é«”å­—ç¬¦
- ä¿®æ­£ Cesium å¼•æ“é©—è­‰æ–¹å¼ï¼ˆä½¿ç”¨è¦–è¦ºå…ƒç´ è€Œé JS å°è±¡ï¼‰
- æ›´æ­£æ¨¡å¼æª¢æ¸¬é‚è¼¯ï¼ˆæª¢æŸ¥å¯¦éš›åœ°åœ–é¡å‹è€ŒéæŒ‰éˆ•ç‹€æ…‹ï¼‰
- æ–°å¢ setPreferredMode() å‡½æ•¸è™•ç†åå¥½è¨­å®š

**æ¸¬è©¦çµæœï¼š**
âœ… TC-04-001 æ¸¬è©¦é€šéï¼ˆ1 passedï¼‰
```

---

## ğŸ’¡ ç¶“é©—æ•™è¨“èˆ‡æœ€ä½³å¯¦è¸

### 1. æœ¬åœ°åŒ–å•é¡Œæª¢æŸ¥æ¸…å–®

**å•é¡Œè­˜åˆ¥**:
- [ ] æª¢æŸ¥ UI å¯¦éš›é¡¯ç¤ºçš„å­—ç¬¦ï¼ˆç°¡é«”/ç¹é«”/èªè¨€è®Šé«”ï¼‰
- [ ] å°æ¯”æ¸¬è©¦ä»£ç¢¼ä¸­çš„å­—ç¬¦ä¸²
- [ ] ä½¿ç”¨ç€è¦½å™¨é–‹ç™¼å·¥å…·ç¢ºèªå…ƒç´ æ–‡å­—

**ä¿®å¾©ç­–ç•¥**:
```typescript
// âŒ é¿å…ï¼šç¡¬ç·¨ç¢¼å–®ä¸€èªè¨€è®Šé«”
const button = page.getByRole('button', { name: 'è¦–è§’1' });

// âœ… æ¨è–¦ï¼šä½¿ç”¨æ­£å‰‡æ”¯æ´å¤šç¨®è®Šé«”
const button = page.getByRole('button', { name: /[è§†è¦–]è§’1/ });

// âœ… æ›´å¥½ï¼šä½¿ç”¨èªè¨€ç„¡é—œçš„å±¬æ€§
const button = page.getByRole('button', { name: /view.*1|è§†è§’1|è¦–è§’1/ });
```

---

### 2. UI æ¶æ§‹ç†è§£è¦æ±‚

**åˆ†ææ–¹æ³•**:
1. **åŠŸèƒ½ç›¸ä¼¼ â‰  æ¶æ§‹ç›¸åŒ**
   - ä¸åŒä½ç½®çš„"æ¨¡å¼åˆ‡æ›"æŒ‰éˆ•å¯èƒ½æœ‰ä¸åŒç”¨é€”
   - å¿…é ˆå€åˆ†"åå¥½è¨­å®š"å’Œ"ç‹€æ…‹åˆ‡æ›"

2. **Selector å¿…é ˆç²¾ç¢º**
   ```typescript
   // âŒ å¤ªå¯¬é¬†ï¼šæœƒåŒ¹é…åˆ°éŒ¯èª¤çš„æŒ‰éˆ•
   const button = page.getByRole('button', { name: /[23]Dæ¨¡å¼/ });

   // âœ… ç²¾ç¢ºï¼šæŒ‡å®šæŒ‰éˆ•çš„ç‰¹å¾µåœ–æ¨™
   const button = page.getByRole('button', { name: /view_in_ar [23]Dæ¨¡å¼/ });
   ```

3. **æ–‡æª”å¿…é ˆæ˜ç¢º**
   - è¨˜éŒ„æ¯ç¨®æŒ‰éˆ•çš„ç”¨é€”å’Œä½ç½®
   - æä¾› selector ç¯„ä¾‹
   - èªªæ˜ä½¿ç”¨å ´æ™¯

---

### 3. é©—è­‰æ–¹æ³•å„ªå…ˆç´š

**å„ªå…ˆç´šæ’åº**:
```
1. è¦–è¦ºå…ƒç´ é©—è­‰ï¼ˆæœ€å¯é ï¼‰
   âœ… ç”¨æˆ¶èƒ½çœ‹åˆ° = æ¸¬è©¦èƒ½é©—è­‰
   âœ… ä¸ä¾è³´å…§éƒ¨å¯¦ç¾

2. DOM å±¬æ€§é©—è­‰
   âœ… æª¢æŸ¥ data-* å±¬æ€§
   âœ… æª¢æŸ¥ aria-* å±¬æ€§

3. API éŸ¿æ‡‰é©—è­‰
   âœ… é©—è­‰æ•¸æ“šå·²è¼‰å…¥
   âš ï¸ ä¸ä¿è­‰ UI å·²æ¸²æŸ“

4. JavaScript å°è±¡æª¢æŸ¥ï¼ˆæœ€ä¸å¯é ï¼‰
   âŒ ä¾è³´å…§éƒ¨å¯¦ç¾
   âŒ æ¨¡çµ„åŒ–æ‡‰ç”¨å¯èƒ½ä¸æš´éœ²
   âŒ å®¹æ˜“å› æ¶æ§‹è®Šæ›´è€Œå¤±æ•ˆ
```

**å¯¦éš›æ¡ˆä¾‹**:
```typescript
// âŒ ä¸å¯é ï¼šJS å°è±¡æª¢æŸ¥
const cesiumReady = await page.evaluate(() =>
  typeof window.Cesium !== 'undefined'
);

// âœ… å¯é ï¼šè¦–è¦ºå…ƒç´ é©—è­‰
const view1Button = page.getByRole('button', { name: /[è§†è¦–]è§’1/ });
const cesiumReady = await view1Button.isVisible();
```

---

### 4. å¯¦éš›æ“ä½œå„ªæ–¼å‡è¨­

**éŒ¯èª¤çš„å·¥ä½œæµç¨‹**:
```
1. é–±è®€ UI è¨­è¨ˆæ–‡æª”
2. æ ¹æ“šæ–‡æª”å‡è¨­æŒ‰éˆ•è¡Œç‚º
3. ç·¨å¯«æ¸¬è©¦ä»£ç¢¼
4. æ¸¬è©¦å¤±æ•— â†’ å›°æƒ‘
```

**æ­£ç¢ºçš„å·¥ä½œæµç¨‹**:
```
1. æ‰‹å‹•æ“ä½œ UI ä¸¦è§€å¯Ÿè¡Œç‚º
2. ä½¿ç”¨ Playwright Inspector éŒ„è£½æ“ä½œ
3. æª¢æŸ¥å¯¦éš›çš„ DOM çµæ§‹å’Œå…ƒç´ å±¬æ€§
4. æ ¹æ“šå¯¦éš›è¡Œç‚ºç·¨å¯«æ¸¬è©¦
5. æ–‡æª”åŒ–ç™¼ç¾çš„è¡Œç‚ºï¼ˆå¯èƒ½èˆ‡è¨­è¨ˆä¸ç¬¦ï¼‰
```

**æœ¬æ¬¡æ¡ˆä¾‹**:
- è¨ˆåŠƒå‡è¨­ï¼šæŒ‰éˆ•æ–‡å­—åæ˜ ç•¶å‰æ¨¡å¼
- å¯¦éš›è¡Œç‚ºï¼šButton Type 1 æ˜¯åå¥½è¨­å®šï¼Œèˆ‡ç•¶å‰æ¨¡å¼ç„¡é—œ
- æ•™è¨“ï¼šå¿…é ˆå¯¦éš›æ“ä½œé©—è­‰ï¼Œä¸èƒ½åªé å‡è¨­

---

## ğŸ”„ ä¸‹ä¸€æ­¥å»ºè­°

### ç«‹å³è¡Œå‹•ï¼ˆé«˜å„ªå…ˆç´šï¼‰

1. **é‹è¡Œå®Œæ•´ P0 æ¸¬è©¦å¥—ä»¶**
   ```bash
   npm run test:p0
   ```
   - é©—è­‰å¯¦éš›é€šéç‡
   - ç¢ºèªæ˜¯å¦æœ‰å…¶ä»–æ¸¬è©¦å—ç›Šæ–¼æœ¬æ¬¡ä¿®å¾©
   - è­˜åˆ¥å‰©é¤˜å¤±æ•—çš„æ¸¬è©¦

2. **æª¢æŸ¥å…¶ä»– 3D æ¸¬è©¦**
   - TC-04-002 è‡³ TC-04-006 å¯èƒ½ä¹Ÿéœ€è¦ç›¸åŒä¿®å¾©
   - æª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»–ç°¡ç¹é«”å­—ç¬¦å•é¡Œ

3. **å»ºç«‹æœ¬åœ°åŒ–æ¸¬è©¦æª¢æŸ¥æ¸…å–®**
   - å°‡ç°¡ç¹é«”æª¢æŸ¥åŠ å…¥ Code Review æµç¨‹
   - å»ºç«‹ selector æœ€ä½³å¯¦è¸æ–‡æª”

---

### çŸ­æœŸæ”¹é€²ï¼ˆæœ¬é€±å…§ï¼‰

1. **Selector ç­–ç•¥çµ±ä¸€**
   - å»ºç«‹ `selectors.ts` é›†ä¸­ç®¡ç†
   - ä½¿ç”¨ `data-testid` å±¬æ€§ï¼ˆéœ€èˆ‡é–‹ç™¼å”èª¿ï¼‰
   - æ¸›å°‘è„†å¼±çš„æ–‡å­—åŒ¹é…

2. **Helper å‡½æ•¸å–®å…ƒæ¸¬è©¦**
   - ç‚º `getCurrentMode()` ç·¨å¯«å–®å…ƒæ¸¬è©¦
   - æ¨¡æ“¬ä¸åŒçš„ DOM ç‹€æ…‹
   - ç¢ºä¿é‚è¼¯æ­£ç¢ºæ€§

3. **æ–‡æª”å®Œå–„**
   - è£œå……å¯¦éš›ä¿®å¾©éç¨‹çš„æˆªåœ–
   - è¨˜éŒ„æ‰€æœ‰ selector è®Šæ›´çš„ç†ç”±
   - å»ºç«‹ troubleshooting æŒ‡å—

---

### ä¸­æœŸå„ªåŒ–ï¼ˆæœ¬æœˆå…§ï¼‰

1. **æ¸¬è©¦ç©©å®šæ€§ç›£æ§**
   - é€£çºŒåŸ·è¡Œ P0 æ¸¬è©¦ 10 æ¬¡
   - è¨˜éŒ„é–“æ­‡æ€§å¤±æ•—ï¼ˆflaky testsï¼‰
   - åˆ†æå¤±æ•—æ¨¡å¼

2. **è¦–è¦ºå›æ­¸æ¸¬è©¦**
   - å»ºç«‹ baseline æˆªåœ–åº«
   - è‡ªå‹•åŒ–æˆªåœ–æ¯”å°
   - è¿½è¹¤ UI è®Šæ›´

---

## ğŸ“š åƒè€ƒè³‡æº

### æœ¬æ¬¡ä¿®å¾©ç›¸é—œæ–‡æª”

- [CLAUDE.md](../../../CLAUDE.md#2d3d-mode-selection-updated-2025-11-24) - ä¸‰ç¨®æŒ‰éˆ•é¡å‹èªªæ˜
- [Mode Switching Guide](../../../docs/guides/mode-switching.md) - æŒ‰éˆ•è¡Œç‚ºè©³è§£
- [Test Framework](../../../docs/architecture/test-framework.md) - æ¸¬è©¦æ¶æ§‹

### æŠ€è¡“è³‡æº

- [Playwright Locators](https://playwright.dev/docs/locators) - Selector ç­–ç•¥
- [Regular Expressions](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions) - æ­£å‰‡è¡¨é”å¼
- [Internationalization Testing](https://playwright.dev/docs/test-global-setup-teardown#internationalization) - åœ‹éš›åŒ–æ¸¬è©¦

---

**æ–‡æª”ç‰ˆæœ¬**: 1.0
**å»ºç«‹æ—¥æœŸ**: 2025-11-24
**ç‹€æ…‹**: âœ… Completed
**ä¸‹æ¬¡å¯©æŸ¥**: é‹è¡Œå®Œæ•´ P0 æ¸¬è©¦å¥—ä»¶å¾Œ

---

**End of Document**
