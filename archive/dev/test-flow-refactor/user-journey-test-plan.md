# 測試流程重構計劃 - 功能模組化 + 使用者體驗流程

**建立日期**: 2025-11-27
**狀態**: ✅ 計劃已確認，待實作

## 📋 目標

將現有分散的 P0/P1/P2 測試案例重新組織為**連貫的使用者體驗流程**，按功能區塊分組，共用頁面狀態，並支援錯誤重試跳過機制。

---

## 🎯 設計原則

1. **流程故事導向** - 模擬真實用戶操作順序
2. **功能區塊分組** - 同一頁面的驗證放在一起
3. **共用頁面狀態** - 減少重複導航，提高效率
4. **錯誤容錯機制** - 單點失敗不阻塞整體流程

---

## 🗺️ 流程故事地圖

### 完整使用者旅程

```
┌─────────────────────────────────────────────────────────────────┐
│                    使用者完整體驗流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  【階段 1】首頁探索                                               │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 1.1 首頁載入驗證 (P1)                                     │    │
│  │ 1.2 賽事搜尋功能 (P1)                                     │    │
│  │ 1.3 年份篩選功能 (P1)                                     │    │
│  │ 1.4 賽事卡片資訊完整性 (P2)                                │    │
│  └─────────────────────────────────────────────────────────┘    │
│                            ↓                                     │
│  【階段 2】進入賽事 + 選擇鴿子                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 2.1 進入賽事詳情 (P1)                                     │    │
│  │ 2.2 排名表格顯示 (P2)                                     │    │
│  │ 2.3 勾選鴿子 + 計數更新 (P2)                              │    │
│  │ 2.4 查看軌跡按鈕狀態 (P2)                                  │    │
│  └─────────────────────────────────────────────────────────┘    │
│                            ↓                                     │
│  【階段 3】2D 軌跡體驗                                            │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 3.1 開啟軌跡 + API 請求驗證 (P0+P1)                        │    │
│  │ 3.2 2D 靜態軌跡渲染 (P0)                                   │    │
│  │     - Canvas 瓦片驗證                                     │    │
│  │     - 軌跡標記點數量 ≥3                                   │    │
│  │     - 起點/終點標記                                       │    │
│  │ 3.3 點擊軌跡點查看資訊 (P0+P1)                             │    │
│  │     - 公環號、時間、速度、方向、海拔、名次                   │    │
│  │ 3.4 側邊欄數據完整性 (P1)                                  │    │
│  │ 3.5 數據邏輯驗證 (P1)                                      │    │
│  │     - 最高分速 ≥ 平均分速                                  │    │
│  │     - 實際距離 ≥ 直線距離                                  │    │
│  └─────────────────────────────────────────────────────────┘    │
│                            ↓                                     │
│  【階段 4】2D 動態模式體驗                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 4.1 靜態→動態切換 (P0)                                    │    │
│  │ 4.2 播放控制驗證 (P0)                                      │    │
│  │     - play/pause 按鈕                                     │    │
│  │     - fast_forward/fast_rewind 按鈕                       │    │
│  │ 4.3 播放功能測試 (P0+P1)                                   │    │
│  │     - 時間戳更新                                          │    │
│  │     - 暫停功能                                            │    │
│  │ 4.4 快進/快退功能 (P1)                                     │    │
│  │ 4.5 速度調整滑桿 (P1)                                      │    │
│  │ 4.6 Canvas 更新驗證 (P0)                                   │    │
│  │ 4.7 動態→靜態切回 (P0)                                    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                            ↓                                     │
│  【階段 5】3D 模式體驗                                            │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 5.1 2D→3D 模式切換 (P0)                                   │    │
│  │ 5.2 Cesium 引擎初始化 (P0)                                 │    │
│  │ 5.3 3D 視覺元素驗證 (P0)                                   │    │
│  │     - 視角1/視角2 按鈕                                    │    │
│  │     - 軌跡點控制按鈕                                      │    │
│  │ 5.4 視角切換功能 (P0+P1)                                   │    │
│  │ 5.5 3D 播放控制 (P0)                                       │    │
│  │ 5.6 速度滑桿 (P0)                                          │    │
│  │ 5.7 3D→2D 切回 (P0)                                       │    │
│  │ 5.8 2D↔3D 來回切換 (P0)                                   │    │
│  └─────────────────────────────────────────────────────────┘    │
│                            ↓                                     │
│  【階段 6】鴿舍列表功能                                           │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 6.1 切換到鴿舍列表 Tab (P1)                                │    │
│  │ 6.2 選擇鴿舍展開 (P1)                                      │    │
│  │ 6.3 多鴿軌跡查看 (P1)                                      │    │
│  │ 6.4 多軌跡 API 驗證 (P1)                                   │    │
│  └─────────────────────────────────────────────────────────┘    │
│                            ↓                                     │
│  【階段 7】控制台錯誤監控 (全程)                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 7.1 收集所有控制台錯誤 (P0+P2)                             │    │
│  │ 7.2 過濾已知錯誤                                          │    │
│  │ 7.3 報告嚴重錯誤                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📊 新舊對照表

| 舊測試案例 | 新位置 | 整合方式 |
|-----------|--------|----------|
| TC-01-001 首頁載入 | 階段 1.1 | 獨立 |
| TC-01-002 搜尋功能 | 階段 1.2 | 與 1.1 共用首頁 |
| TC-01-003 年份篩選 | 階段 1.3 | 與 1.1 共用首頁 |
| TC-01-004 進入賽事 | 階段 2.1 | 作為階段 2 入口 |
| TC-02-001 2D 靜態渲染 | 階段 3.2 | 整合到 2D 流程 |
| TC-02-002 起點終點標記 | 階段 3.2 | 合併 |
| TC-02-004 點擊軌跡點 | 階段 3.3 | 順序驗證 |
| TC-02-005 軌跡線渲染 | 階段 3.2 | 合併視覺驗證 |
| TC-02-006 網路請求 | 階段 3.1 | 合併到開啟軌跡 |
| TC-03-001 靜態動態切換 | 階段 4.1, 4.7 | 拆分到模式切換 |
| TC-03-002 播放功能 | 階段 4.3 | 整合 |
| TC-03-007 Canvas 更新 | 階段 4.6 | 整合 |
| TC-04-001 切換3D | 階段 5.1 | 整合 |
| TC-04-002 Cesium引擎 | 階段 5.2 | 順序驗證 |
| TC-04-003 視角切換 | 階段 5.4 | 整合 |
| TC-06-001 側邊欄數據 | 階段 3.4 | 在 2D 流程中驗證 |
| TC-06-002 數據邏輯 | 階段 3.5 | 順序驗證 |
| TC-07-006 控制台錯誤 | 階段 7 | 全程監控 |

---

## 🔗 階段依賴關係圖

```
階段 1 (首頁) ──→ 階段 2 (進入賽事) ──→ 階段 3 (2D軌跡)
   │                  │                    │
   │                  │                    ↓
   │                  │              階段 4 (2D動態)
   │                  │                    │
   │                  │                    ↓
   │                  │              階段 5 (3D模式)
   │                  │                    │
   │                  ↓                    │
   │            階段 6 (鴿舍列表) ←────────┘
   │                  │
   └──────────────────┴──→ 階段 7 (錯誤監控，全程)

依賴規則：
├─ 階段 1 失敗 → 全部終止
├─ 階段 2 失敗 → 終止（無法進入賽事）
├─ 階段 3 失敗 → 跳過 4、5，嘗試 6
├─ 階段 4 失敗 → 嘗試 5、6
├─ 階段 5 失敗 → 嘗試 6
└─ 階段 6 失敗 → 僅記錄，不影響報告
```

---

## 📋 各階段詳細驗證點

### 階段 1: 首頁探索 (4 個驗證點)

| # | 驗證點 | 優先級 | 判斷方法 | 失敗影響 |
|---|--------|--------|----------|----------|
| 1.1 | 首頁載入成功 | P1 | `page.title()` 包含 "Skyracing" | 🔴 終止全部 |
| 1.2 | 賽事卡片 ≥10 個 | P1 | `mat-card.count() >= 10` | ⚠️ 警告 |
| 1.3 | 搜尋功能可用 | P1 | 輸入後結果過濾 | ⚠️ 記錄 |
| 1.4 | 年份篩選可用 | P2 | 下拉選單響應 | ⚠️ 記錄 |

**退出條件**: 1.1 必須通過，其他記錄結果

---

### 階段 2: 進入賽事 + 選擇鴿子 (4 個驗證點)

| # | 驗證點 | 優先級 | 判斷方法 | 失敗影響 |
|---|--------|--------|----------|----------|
| 2.1 | 進入按鈕可點擊 | P1 | 點擊後頁面跳轉 | 🔴 終止全部 |
| 2.2 | 排名表格顯示 | P2 | `table` 可見，行數 ≥10 | ⚠️ 警告 |
| 2.3 | 勾選鴿子成功 | P0 | checkbox 狀態改變 | 🔴 終止全部 |
| 2.4 | 勾選計數更新 | P2 | 「勾選清單 1」文字出現 | ⚠️ 記錄 |

**退出條件**: 2.1 + 2.3 必須通過

---

### 階段 3: 2D 軌跡體驗 (6 個驗證點)

**前置**: 階段 2 通過

| # | 驗證點 | 優先級 | 判斷方法 | 失敗影響 |
|---|--------|--------|----------|----------|
| 3.1 | 查看軌跡按鈕啟用 | P0 | `button.isEnabled()` | 🔴 阻斷 3-5 |
| 3.2 | API 請求發送 | P1 | 攔截 `ugetPigeonAllJsonInfo` | ⚠️ 記錄 |
| 3.3 | Canvas 渲染成功 | P0 | `canvas.amap-layer.count() > 0` | ⚠️ 警告 |
| 3.4 | 軌跡標記點 ≥3 | P0 | `.amap-icon > img.count() >= 3` | ⚠️ 警告 |
| 3.5 | 點擊標記點顯示資訊 | P0 | 彈窗包含：時間、速度、方向、海拔 | ⚠️ 記錄 |
| 3.6 | 側邊欄數據完整 | P1 | 公環號格式正確、分速 > 0 | ⚠️ 記錄 |

**退出條件**: 3.1 必須通過，其他盡量執行

---

### 階段 4: 2D 動態模式 (7 個驗證點)

**前置**: 階段 3.3 (Canvas) 通過

| # | 驗證點 | 優先級 | 判斷方法 | 失敗影響 |
|---|--------|--------|----------|----------|
| 4.1 | 靜態→動態切換 | P0 | 標記點數量 < 5 | ⚠️ 警告 |
| 4.2 | 播放按鈕可見 | P0 | `play_arrow` 按鈕存在 | ⚠️ 警告 |
| 4.3 | 暫停按鈕可見 | P0 | 點擊後變 `pause` | ⚠️ 記錄 |
| 4.4 | 快進功能 | P1 | 時間跳躍 | ⚠️ 記錄 |
| 4.5 | 快退功能 | P1 | 時間回退 | ⚠️ 記錄 |
| 4.6 | Canvas 更新 | P0 | 截圖前後不同 | ⚠️ 記錄 |
| 4.7 | 動態→靜態切回 | P0 | 標記點數量 ≥ 3 | ⚠️ 記錄 |

**退出條件**: 盡量執行全部，失敗不阻斷後續

---

### 階段 5: 3D 模式體驗 (8 個驗證點)

**前置**: 階段 3.3 (Canvas) 通過

| # | 驗證點 | 優先級 | 判斷方法 | 失敗影響 |
|---|--------|--------|----------|----------|
| 5.1 | 2D→3D 切換 | P0 | 「2D模式」按鈕出現 | ⚠️ 阻斷 5.2-5.8 |
| 5.2 | Cesium 初始化 | P0 | 視角按鈕可見 (視覺驗證) | ⚠️ 警告 |
| 5.3 | 視角1 按鈕 | P0 | `/[视視]角1/` 可見 | ⚠️ 記錄 |
| 5.4 | 視角2 按鈕 | P0 | `/[视視]角2/` 可見 | ⚠️ 記錄 |
| 5.5 | 視角切換功能 | P1 | 點擊後截圖不同 | ⚠️ 記錄 |
| 5.6 | 3D 播放控制 | P0 | play/快進/快退 按鈕 | ⚠️ 記錄 |
| 5.7 | 速度滑桿 | P0 | slider 可見 | ⚠️ 記錄 |
| 5.8 | 3D→2D 切回 | P0 | 「3D模式」按鈕出現 | ⚠️ 記錄 |

**退出條件**: 5.1 必須通過才能執行後續

---

### 階段 6: 鴿舍列表多鴿軌跡 (4 個驗證點)

**前置**: 階段 2 通過（需要返回賽事頁面）

| # | 驗證點 | 優先級 | 判斷方法 | 失敗影響 |
|---|--------|--------|----------|----------|
| 6.1 | 切換到鴿舍列表 Tab | P1 | Tab 切換成功 | ⚠️ 阻斷 6.2-6.4 |
| 6.2 | 選擇鴿舍展開 | P1 | 鴿子列表可見 | ⚠️ 警告 |
| 6.3 | 勾選多隻鴿子 (2+) | P1 | 「勾選清單 2」 | ⚠️ 警告 |
| 6.4 | 查看多軌跡 | P1 | API 呼叫 ≥2 次 | ⚠️ 記錄 |

**退出條件**: 盡量執行，失敗僅記錄

---

### 階段 7: 控制台錯誤監控 (全程)

| # | 驗證點 | 優先級 | 判斷方法 | 失敗影響 |
|---|--------|--------|----------|----------|
| 7.1 | 收集所有 console.error | P0 | 監聽 `page.on('console')` | - |
| 7.2 | 過濾已知錯誤 | P2 | 排除白名單內容 | - |
| 7.3 | 嚴重錯誤 = 0 | P0 | 過濾後錯誤數 | ⚠️ 警告 |

**特殊**: 全程背景執行，最後統計報告

---

## 📊 驗證點統計

| 優先級 | 數量 | 說明 |
|--------|------|------|
| P0 | 22 | 核心功能，必須驗證 |
| P1 | 10 | 重要功能，應該驗證 |
| P2 | 4 | 輔助功能，盡量驗證 |
| **總計** | **36** | 整合後的驗證點 |

**vs 原本分散的測試案例**: 38 個 → 36 個驗證點（減少重複）

---

## 🔧 錯誤容錯機制

### 重試策略

```
每個驗證點執行策略：
┌─────────────────────────────────────────┐
│  執行驗證                               │
│      ↓                                  │
│  成功? ──→ [是] ──→ 記錄通過，繼續下一步  │
│      │                                  │
│      └→ [否] ──→ 重試 (最多 2 次)        │
│                    ↓                    │
│               仍失敗?                    │
│                    ↓                    │
│               [是] ──→ 記錄失敗位置      │
│                        標記該階段錯誤    │
│                        跳到下一階段      │
└─────────────────────────────────────────┘
```

### 報告格式

```
📊 測試執行報告
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

階段 1: 首頁探索          ✅ 4/4 通過
階段 2: 進入賽事          ✅ 4/4 通過
階段 3: 2D 軌跡體驗       ⚠️ 4/5 通過
        └─ 3.3 點擊軌跡點  ❌ 失敗 (已重試 2 次)
階段 4: 2D 動態模式       ✅ 7/7 通過
階段 5: 3D 模式體驗       ✅ 8/8 通過
階段 6: 鴿舍列表          ✅ 4/4 通過
階段 7: 控制台監控        ✅ 無嚴重錯誤

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
總計: 35/36 通過 (97.2%)
失敗階段: 階段 3.3
```

---

## 🔁 重試與跳過機制

```typescript
// 虛擬碼示意
async function runStage(stage: Stage) {
  for (const checkpoint of stage.checkpoints) {
    let passed = false;

    for (let attempt = 1; attempt <= 3; attempt++) {
      try {
        await checkpoint.verify();
        passed = true;
        report.record(checkpoint, 'PASS');
        break;
      } catch (error) {
        if (attempt < 3) {
          await page.waitForTimeout(1000);
          continue;
        }
        report.record(checkpoint, 'FAIL', error);
      }
    }

    // 檢查是否阻斷
    if (!passed && checkpoint.isBlocking) {
      return { status: 'BLOCKED', blockedBy: checkpoint };
    }
  }

  return { status: 'COMPLETE' };
}
```

---

## 📁 預計檔案結構

```
tests/
├── e2e/
│   └── user-journey.spec.ts      # 主流程測試 (整合版)
│       ├── describe('階段 1: 首頁探索')
│       ├── describe('階段 2: 進入賽事')
│       ├── describe('階段 3: 2D 軌跡')
│       ├── describe('階段 4: 2D 動態')
│       ├── describe('階段 5: 3D 模式')
│       ├── describe('階段 6: 鴿舍列表')
│       └── afterAll('階段 7: 錯誤報告')
└── helpers/
    ├── stage-runner.ts           # 階段執行器 (含重試+阻斷邏輯)
    ├── checkpoint-verifier.ts    # 驗證點執行器
    └── journey-reporter.ts       # 旅程報告生成器
```

---

## ✅ 確認事項

- [x] 鴿舍列表納入主流程
- [x] 採用依賴阻斷策略
- [x] 各階段驗證點已細化
- [x] 重試機制設計完成

---

## 📅 下一步行動

1. [ ] 建立 `tests/e2e/user-journey.spec.ts` 測試檔案
2. [ ] 實作 `stage-runner.ts` 階段執行器
3. [ ] 實作 `checkpoint-verifier.ts` 驗證點執行器
4. [ ] 實作 `journey-reporter.ts` 報告生成器
5. [ ] 整合現有 helper 函數
6. [ ] 執行測試驗證
